var Application=new Backbone.Marionette.Application;Application.Admin={Model:{},View:{},Collection:{},Router:{}};Application.Model={};Application.View={};Application.Collection={};Application.Router={};Application.addRegions({header:"body > .header",content:"body > .content",footer:"body > .footer"});Backbone.Marionette.Region.prototype.is=function(view){if(this.currentView===view){return true}else if(this.currentView===undefined){return false}else if(this.currentView.name===view){return true}else{return false}};Application.addInitializer(function(options){Application.session=new Application.Model.Session;var cookie=$.cookie("ptsession");if(cookie){Application.session.set("ptsession",cookie)}});Application.addInitializer(function(options){if(options.router==="admin"){Application.router=new Application.Router.Admin}else{Application.router=new Application.Router.User}});Application.addInitializer(function(){var closeBtn='<a title="Close" class="fancybox-item fancybox-close">';closeBtn+='<i class="icon-remove-circle"></i>';closeBtn+="</a>";$(".fancybox").fancybox({maxWidth:970,maxHeight:800,fitToView:false,width:"70%",height:"90%",autoSize:false,closeClick:false,openEffect:"none",closeEffect:"none",arrows:false,tpl:{closeBtn:closeBtn}})});Application.on("initialize:after",function(options){var matched=Backbone.history.start({root:"/"});Application.session.check(function(){if(matched){return}else{Backbone.history.navigate("timeline",true)}},function(){if(["login","register"].indexOf(Backbone.history.fragment)!==-1){return}else{Backbone.history.navigate("login",true)}})});function hashCode(){var hash=0,i,char;if(this.length==0)return hash;for(i=0;i<this.length;i++){char=this.charCodeAt(i);hash=(hash<<5)-hash+char;hash=hash&hash}return hash}function displayValidationErrors(messages){for(var key in messages){if(messages.hasOwnProperty(key)){addValidationError(key,messages[key])}}}function addValidationError(field,message){var controlGroup=$("#"+field).parent();controlGroup.addClass("error");$(".hint",controlGroup).html(message)}function removeValidationError(field){var controlGroup=$("#"+field).parent();controlGroup.removeClass("error");$(".hint",controlGroup).html("")}Application.Model.Credentials=Backbone.Model.extend({defaults:{pid:null,pwd:null},url:"/-session",initialize:function(){this.validators={};this.validators.pid=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your username."}};this.validators.pwd=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your password."}}},validateItem:function(key){return this.validators[key]?this.validators[key](this.get(key)):{isValid:true}},validateAll:function(){var messages={};for(var key in this.validators){if(this.validators.hasOwnProperty(key)){var check=this.validators[key](this.get(key));if(check.isValid===false){messages[key]=check.message}}}return _.size(messages)>0?{isValid:false,messages:messages}:{isValid:true}}});Application.Model.Feed=Backbone.Model.extend({});Application.Model.Item=Backbone.Model.extend({idAttribute:"uid",now:false,initialize:function(){this.set("uid",this.get("id")+"-"+this.get("ts"),{silent:true})},idSafe:function(){return this.id.replace(/@/,"\\@")},time:function(){return moment.unix(this.get("ts").toString().substr(0,10))},isNow:function(){return this.now},isPast:function(){return this.time().diff()<0},isToday:function(){return Math.abs(this.time().diff())<moment().add("day",1).diff()},isEvent:function(){return this.get("ts").toString().substr(0,10)==this.get("event")},isVideo:function(){return this.get("media")==="video"},isAudio:function(){return this.get("media")==="audio"},isAdded:function(){return this.get("ts").toString().substr(0,10)==this.get("added")},save:function(done,fail){var promise=$.ajax({url:"/-tadd",type:"post",data:{pid:Application.session.get("pid"),link:this.get("link"),text:this.get("text"),ets:this.get("ets")}});promise.done(done);promise.fail(fail);return promise},promote:function(done,fail){var self=this;var promise=$.ajax({url:"/-tpromote",type:"post",data:{pid:Application.session.get("pid"),id:this.get("id")}});promise.done(function(data){self.trigger("item:promoted",data)});promise.done(done);promise.fail(fail);return promise},demote:function(done,fail){var defer=$.Deferred();defer.done(done);defer.fail(fail);this.trigger("item:demoted",this);$.ajax({url:"/-tdemote",type:"post",data:{pid:Application.session.get("pid"),id:this.get("id")},success:function(){defer.resolve()},failure:function(){defer.reject()}});return defer.promise()}});Application.Model.Profile=Backbone.Model.extend({defaults:{name:undefined,bio:undefined,email:undefined},idAttribute:"pid",url:function(){return"/-jpr?pid="+this.get("pid")},follow:function(done,fail){var defer=$.Deferred();defer.done(done);defer.fail(fail);this.collection.trigger("profile:follow",this.attributes);this.trigger("follow",this.attributes);$.ajax({url:"/-tfollow",type:"post",data:{pid:Application.session.get("pid"),followpid:this.get("pid")},success:function(){defer.resolve()},failure:function(){defer.reject()}});return defer.promise()},unfollow:function(done,fail){var defer=$.Deferred();defer.done(done);defer.fail(fail);this.collection.trigger("profile:unfollow",this.attributes);this.collection.remove(this);this.trigger("unfollow",this.attributes);$.ajax({url:"/-tunfollow",type:"post",data:{pid:Application.session.get("pid"),followpid:this.get("pid")},success:function(){defer.resolve()},failure:function(){defer.reject()}});return defer.promise()}});Application.Model.RegistrationInfo=Backbone.Model.extend({defaults:{pid:null,pwd:null,name:null},url:"/-session",initialize:function(){this.validators={};this.validators.pid=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your username."}};this.validators.pwd=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your password."}};this.validators.name=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your full name."}}},validateItem:function(key){return this.validators[key]?this.validators[key](this.get(key)):{isValid:true}},validateAll:function(){var messages={};for(var key in this.validators){if(this.validators.hasOwnProperty(key)){var check=this.validators[key](this.get(key));if(check.isValid===false){messages[key]=check.message}}}return _.size(messages)>0?{isValid:false,messages:messages}:{isValid:true}}});Application.Model.Search=Backbone.Model.extend({idAttribute:"uid",initialize:function(){this.set("uid",this.get("id")+"-"+this.get("ts"),{silent:true})},time:function(){if(this.isEvent()===true){return moment.unix(this.get("event"))}else{return moment.unix(this.get("added"))}},isNow:function(){return this.now},isPast:function(){return this.time().diff()<0},isToday:function(){return Math.abs(this.time().diff())<moment().add("day",1).diff()},isEvent:function(){return this.get("event")!==0},isVideo:function(){return this.get("media")==="video"},isAudio:function(){return this.get("media")==="audio"},isAdded:function(){return this.get("added")!==0},promote:function(done,fail){var self=this;var promise=$.ajax({url:"/-tpromote",type:"post",data:{pid:Application.session.get("pid"),id:this.get("id")}});promise.done(function(data){self.trigger("item:promoted",data)});promise.done(done);promise.fail(fail);return promise},demote:function(done,fail){var defer=$.Deferred();defer.done(done);defer.fail(fail);this.trigger("item:demoted",this);$.ajax({url:"/-tdemote",type:"post",data:{pid:Application.session.get("pid"),id:this.get("id")},success:function(){defer.resolve()},failure:function(){defer.reject()}});return defer.promise()}});Application.Model.Session=Backbone.Model.extend({initialize:function(){var cookie=$.cookie("ptsession");if(cookie!==undefined){this.set("pid",cookie.split("|")[0])}},check:function(done,fail){var self=this;var defer=$.Deferred();defer.done(done);defer.fail(fail);if(this.get("ptsession")){$.ajax({url:"/-chksession"}).done(function(){var cookie=$.cookie("ptsession");if(cookie!==undefined){self.set("pid",cookie.split("|")[0])}defer.resolve()}).fail(function(){self.set("pid",null);defer.reject()})}else{defer.reject()}return defer.promise()},save:function(done,fail){var self=this;var defer=$.Deferred();defer.done(done);defer.fail(fail);$.ajax({url:"/-session",type:"post",data:{pid:self.get("pid"),pwd:self.get("pwd")}}).done(function(data){self.set("pwd",null);self.set("ptsession",$.cookie("ptsession"));defer.resolve(data)}).fail(function(data){self.set("pwd",null);defer.fail(data)});return defer.promise()},destroy:function(){$.cookie("ptsession",null);Backbone.Model.prototype.destroy.apply(this)}});Application.Collection.Feeds=Backbone.Collection.extend({model:Application.Model.Feed,initialize:function(options){this.pid=options.pid},url:function(){return"/-jfeeds?pid="+this.pid}});Application.Collection.Followers=Backbone.Collection.extend({model:Application.Model.Profile,url:"/-jfollowers"});Application.Collection.Followings=Backbone.Collection.extend({model:Application.Model.Profile,url:"/-jfollowing"});Application.Collection.Items=Backbone.Collection.extend({model:Application.Model.Item,url:"/-jtl",initialize:function(collection,options){this.options=options;this.on("item:demoted",function(target){var models=this.filter(function(item){return item.get("id")===target.get("id")});this.remove(models)})},fetch:function(options){options.data=_.extend(this.options,options.data);return Backbone.Collection.prototype.fetch.call(this,options)},now:function(){var self=this;var options={data:{pid:this.options.pid,status:this.options.status},remove:false};var defer=$.Deferred();Backbone.Collection.prototype.fetch.call(this,options).done(function(data){if(data.length===0){defer.reject()}else{self.each(function(model){model.now=false});var model=self.get(data[0].id+"-"+data[0].ts);model.now=true;defer.resolve(model)}}).fail(function(){defer.reject()});return defer.promise()},comparator:function(model){return-model.get("ts")}});var ProfileItems=Backbone.Collection.extend({model:Application.Model.Item,initialize:function(options){this.pid=options.pid},url:function(){return"/-jtl?status=m&count=30&pid="+this.pid}});Application.Collection.Searches=Backbone.Collection.extend({model:Application.Model.Search,url:"/-jsearch",initialize:function(collection,options){this.options=options||{};this.on("item:demoted",function(target){var models=this.filter(function(item){return item.get("id")===target.get("id")});this.remove(models)})},search:function(options){var self=this;var promise=$.ajax({url:this.url,type:"get",dataType:"json",data:options.data});promise.done(function(data){self.set(data.results)});promise.fail(function(){});return promise},comparator:function(model){return-model.get("ts")}});Application.View.Timeline=Backbone.Marionette.ItemView.extend({name:"timeline",template:"#timeline-template",className:"column",infiniteScrollReference:null,infiniteScrollLastUpdate:moment().subtract("seconds",2),initialEvents:function(){$(window).on("resize",_.bind(this.resize,this));this.on("item:add",function(event){this.region.currentView.trigger("item:add",event)});this.on("view:timeline",function(pid){this.timeline(pid)});this.on("all",function(event){var match=event.match(/view:(.*)/);if(match===null){return}this.model.set("view",match[1])});this.on("scroll",this.infiniteScroll)},bindEvents:function(view){if(view.collection){this.listenToOnce(view.collection,"sync",function(event){view.$el.find(".item").first().transitionEnd(_.bind(function(event){if(event.propertyName!=="max-height"){return}this.now()},this))})}this.listenTo(view,"show",this.resize);this.listenTo(view,"scroll",this.infiniteScroll);this.listenTo(view,"scrollTo",function(event){var $scroller=this.$el.find(".scroller");if(event.top===$scroller.scrollTop()){return}view.trigger("scrollTo:start");$scroller.animate({scrollTop:event.top,scrollLeft:event.left},event.duration,function(){view.trigger("scrollTo:done")})})},resize:function(){this.$el.find(".scroller").height($(window).height()-60)},reload:function(){this.region.currentView.trigger("reload",this)},now:function(){this.region.currentView.trigger("now",this)},refresh:function(){this.listenToOnce(this.region.currentView,"reload:done",function(){this.region.currentView.$el.find(".item").first().transitionEnd(_.bind(function(){if(event.propertyName!=="max-height"){return}this.now()},this))});this.reload()},onRender:function(){this.region=new Backbone.Marionette.Region({el:this.$el.find(".collection")});this.trigger("view:"+this.model.get("view"))},infiniteScroll:function(event){var deferred=_.bind(this.infiniteScrollDeferred,this,event);clearTimeout(this.infiniteScrollReference);this.infiniteScrollReference=setTimeout(deferred,150)},infiniteScrollDeferred:function(event){var $target=$(event.target);var threshold=140*20;var scrollTop=$target.scrollTop(),maxScrollTop=$target.find(".children").height();if(this.infiniteScrollLoading===true){return}else if(moment().diff(this.infiniteScrollLastUpdate)<2e3){return}else if(Math.abs(scrollTop)<threshold){this.infiniteScrollLastUpdate=moment();this.region.currentView.trigger("infinite:load",{after:true})}else if(Math.abs(scrollTop)>Math.abs(maxScrollTop-threshold)){this.infiniteScrollLastUpdate=moment();this.region.currentView.trigger("infinite:load",{before:true})}else{return}}});Application.View.TimelineItem=Backbone.Marionette.ItemView.extend({modelEvents:{"item:promoted":"onPromoted","item:demoted":"onDemoted"},attributes:function(){var attributes={"data-id":this.model.id};if(this.model.get("image")){attributes.style="background-image: url(/-img/"+this.model.get("image")+")"}return attributes},remove:function(){var self=this,args=arguments;this.$el.transitionEnd(function(event){if(event.propertyName!=="max-height"){return}Backbone.Marionette.ItemView.prototype.remove.apply(self,args)});this.$el.addClass("collapsed")},onPromoted:function(){this.$el.removeClass("now").addClass("promoted")},onDemoted:function(){},onShow:function(){this.$el.offset();this.$el.removeClass("collapsed")},onRender:function(){this.$el.data("model",this.model)}});Application.View.TimelineProfile=Backbone.Marionette.ItemView.extend({className:"item collapsed",attributes:function(){return{"data-pid":this.model.get("pid")}},onShow:function(){this.$el.offset();this.$el.removeClass("collapsed")},onRender:function(){this.$el.data("model",this.model)},remove:function(){var self=this,args=arguments;this.$el.transitionEnd(function(event){if(event.propertyName!=="max-height"){return}Backbone.Marionette.ItemView.prototype.remove.apply(self,args)});this.$el.addClass("collapsed")}});var BriefFeedView=Backbone.View.extend({initialize:function(options){this.template=_.template($("#brieffeed-tmpl").html())},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));return this}});Application.Admin.View.BriefItemView=Backbone.Marionette.CollectionView.extend({itemView:Application.Model.Item,itemViewTemplate:"#briefitem-tmpl"});Application.View.ProfileBrief=Backbone.Marionette.ItemView.extend({template:"#briefprofile-tmpl"});var EditFeedView=Backbone.View.extend({events:{"click .saveBtn":"save"},initialize:function(options){this.template=_.template($("#editfeed-tmpl").html())},save:function(){var self=this;$.ajax({url:"/-tupdateprofile",type:"post",data:{pid:this.model.get("pid"),name:$("#name").val(),parentpid:$("#parentpid").val(),feedurl:$("#feedurl").val()},success:function(data){Backbone.history.navigate("profile/"+self.model.get("pid"),true)}});return false},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));return this}});var FeedView=Backbone.View.extend({events:{"click .editBtn":"edit","click .refreshBtn":"refresh","click .deleteBtn":"delete"},initialize:function(options){this.template=_.template($("#feed-tmpl").html());this.msg="";this.initItemViews(options.items)},edit:function(){Backbone.history.navigate("editprofile/"+this.model.get("pid"),true);return false},refresh:function(){var self=this;$.ajax({url:"/-refresh",type:"get",data:{pid:self.model.get("pid")},success:function(data){var items=new ProfileItems({pid:self.model.get("pid")});items.fetch({success:function(){self.initItemViews(items);self.msg="";self.render()},error:function(request,status,error){self.msg="There was a problem displaying feed items: "+request.responseText;self.render()}})},error:function(request,status,error){self.msg="There was a problem refreshing feed items: "+request.responseText;self.render()}});return false},"delete":function(){var self=this;$.ajax({url:"/-tremprofile",type:"post",data:{pid:self.model.get("pid")},success:function(){Backbone.history.navigate("profile/"+self.model.get("parentpid"),true)},error:function(request,status,error){self.msg="There was a problem deleting the feed: "+request.responseText;self.render()}});return false},initItemViews:function(items){this._views=[];var self=this;items.each(function(m){self._views.push(new BriefItemView({model:m}))})},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));$(".msg",this.el).html(this.msg);var self=this;_(this._views).each(function(v){$(".items",self.el).append(v.render().el)});return this}});Application.Admin.FeedNew=Backbone.Marionette.ItemView.extend({template:"#addfeed-tmpl",events:{"click .saveBtn":"save"},save:function(event){var self=this;var data=$(event.target).serializeObject();var promise=$.ajax({url:"/-taddprofile",type:"post",data:{pid:this.model.get("pid")+"~"+$("#feedpid").val(),name:$("#name").val(),parentpid:this.model.get("pid"),feedurl:$("#feedurl").val()}});promise.done(function(){Backbone.history.navigate("profile/"+self.model.get("pid"),true)});promise.fail(function(){});return false}});var FeedsListView=Backbone.View.extend({initialize:function(options){var self=this;this.template=_.template($("#feeds-tmpl").html());this._views=[];this.collection.each(function(m){self._views.push(new BriefFeedView({model:m}))})},render:function(){var self=this;$(this.el).html(this.template({data:{pid:this.collection.pid}}));_(this._views).each(function(v){$(self.el).append(v.render().el)});return this}});Application.Admin.View.Followers=Backbone.Marionette.CollectionView.extend({template:"#followers-tmpl",itemView:Application.Admin.View.FollowerBrief});Application.Admin.View.Following=Backbone.Marionette.CollectionView.extend({template:"#following-tmpl",itemView:Application.View.ProfileBrief});Application.Admin.View.Home=Backbone.Marionette.ItemView.extend({template:"#home-template",className:"container",events:{"submit form":"profile"},profile:function(){var url="profile/"+this.$el.find("input[name=pid]").val();Backbone.history.navigate(url,true);return false}});Application.Admin.View.ProfileEdit=Backbone.Marionette.ItemView.extend({template:"#editprofile-tmpl",events:{"click .saveBtn":"save"},save:function(event){var self=this;var data=$(event.target).serializeObject();var promise=$.ajax({url:"/-tupdateprofile",type:"post",data:data});promise.done(function(){Backbone.history.navigate("profile/"+self.model.get("pid"),true)});promise.fail(function(){});return false}});Application.Admin.View.ProfileNew=Backbone.Marionette.ItemView.extend({template:"#addprofile-tmpl",events:{"submit form":"submit"},submit:function(event){var data=$(event.target).serializeObject();var promise=$.ajax({url:"/-taddprofile",type:"post",data:data});promise.done(function(){Backbone.history.navigate("profile/"+data.pid,true)});promise.fail(function(){});return false}});Application.Admin.View.ProfileView=Backbone.Marionette.ItemView.extend({template:"#profile-tmpl",events:{"click .editBtn":"edit","click .feedBtn":"addfeed"},edit:function(){Backbone.history.navigate("profile/"+this.model.get("pid")+"/feed/edit/",true);return false},addfeed:function(){Backbone.history.navigate("profile/"+this.model.get("pid")+"/feed/new",true);return false},onRender:function(){var view=new Application.Admin.View.BriefItemView({collection:this.model.get("items")});this.$el.find(".items").append(view.el)}});var StaticView=Backbone.View.extend({initialize:function(options){this.template=_.template($("#"+options.name+"-tmpl").html())},render:function(){$(this.el).html(this.template());return this}});Application.View.Follower=Application.View.TimelineProfile.extend({template:"#follower-template"});Application.View.Followers=Backbone.Marionette.CompositeView.extend({template:"#followers-template",className:"followers",itemView:Application.View.Follower,itemViewContainer:".children",events:{"click .unfollow":"unfollow","click .follow":"follow"},initialize:function(options){this.on("infinite:load",this.load);this.on("infinite:load",this.loading);this.on("infinite:loaded",this.loaded);this.on("infinite:failed",this.loaded)},onShow:function(){this.delegateEvents();this.collection.fetch({data:{pid:this.model.get("pid"),count:this.model.get("count")},remove:true})},follow:function(event){var $profile=$(event.currentTarget).closest("[data-pid]");var model=this.collection.get($profile.data("pid"));model.follow()},unfollow:function(event){var $profile=$(event.currentTarget).closest("[data-pid]");var model=this.collection.get($profile.data("pid"));model.unfollow()},load:function(options){if(options.before){return}var self=this;var data={pid:self.model.get("pid"),start:self.model.get("start"),count:10};self.collection.fetch({remove:false,data:data}).done(function(data){if(data.length>0){self.model.set("start",data.start+10)}self.trigger("infinite:loaded")}).fail(function(){self.trigger("infinite:failed")})},loading:function(options){this.loading=new Application.View.Loading(options);this.loading.render();this.$el.append(this.loading.$el)},loaded:function(options){this.loading.remove()}});Application.View.Following=Application.View.TimelineProfile.extend({template:"#follower-template"});Application.View.Followings=Backbone.Marionette.CompositeView.extend({template:"#followers-template",className:"followings",itemView:Application.View.Following,itemViewContainer:".children",events:{"click .unfollow":"unfollow"},initialize:function(options){this.on("infinite:load",this.load);this.on("infinite:load",this.loading);this.on("infinite:loaded",this.loaded);this.on("infinite:failed",this.loaded)},onShow:function(){this.delegateEvents();this.collection.fetch({data:{pid:this.model.get("pid"),count:this.model.get("count")},remove:true})},unfollow:function(event){var $profile=$(event.currentTarget).closest("[data-pid]");var model=this.collection.get($profile.data("pid"));model.unfollow()},load:function(options){if(options.before){return}var self=this;var data={pid:self.model.get("pid"),start:self.model.get("start"),count:10};self.collection.fetch({remove:false,data:data}).done(function(data){if(data.length>0){self.model.set("start",data.start+10)}self.trigger("infinite:loaded")}).fail(function(){self.trigger("infinite:failed")})},loading:function(options){this.loading=new Application.View.Loading(options);this.loading.render();this.$el.append(this.loading.$el)},loaded:function(options){this.loading.remove()}});Application.View.Header=Backbone.Marionette.ItemView.extend({template:"#header-template",className:"navbar navbar-fixed",initialize:function(options){}});Application.View.ItemAdd=Backbone.Marionette.ItemView.extend({template:"#item-add-template",className:"item",events:{"submit form":"submit","click .cancel":"cancel"},modelEvents:{change:"render"},initialize:function(options){this.model=new Application.Model.Item({link:"",text:"",ets:""});this.on("set:link",function(value){this.model.set("link",value)});this.on("set:text",function(value){this.model.set("text",value)});this.on("set:ets",function(value){this.model.set("ets",value)})},submit:function(event){var data=$(event.target).serializeObject();var promise=this.model.set(data).save();promise.done(function(){self.trigger("created")});promise.fail(function(){console.log("TODO: Display errors")});return false},cancel:function(){this.trigger("cancelled");return false},onShow:function(){this.delegateEvents()}});Application.View.ItemEmpty=Backbone.Marionette.ItemView.extend({template:"#item-empty-template",className:"item empty collapsed",onShow:function(){this.$el.offset();this.$el.removeClass("collapsed")},remove:function(){var self=this,args=arguments;this.$el.transitionEnd(function(event){if(event.propertyName!=="max-height"){return}Backbone.Marionette.ItemView.prototype.remove.apply(self,args)});this.$el.addClass("collapsed")}});Application.View.Item=Application.View.TimelineItem.extend({template:"#item-template",templateHelpers:{isEvent:function(ts,event){return Application.Model.Item.prototype.isEvent.apply(new Backbone.Model({ts:ts,event:event}))},time:function(ts){return Application.Model.Item.prototype.time.apply(new Backbone.Model({ts:ts}))}},className:function(){var className="item collapsed";if(this.model.get("image")){className+=" image"}if(this.model.isEvent()){className+=" event"}else if(this.model.isVideo()){className+=" video"}else if(this.model.isAudio()){className+=" audio"}if(this.model.isAdded()){className+=" added"}if(this.model.isPast()){className+=" past"}return className}});Application.View.Items=Backbone.Marionette.CompositeView.extend({template:"#items-template",className:"items",events:{"click .promote":"promote","click .demote":"demote","click .icon-repeat":"now"},itemViewContainer:".children",itemView:Application.View.Item,emptyView:Application.View.ItemEmpty,collectionEvents:{"item:promoted":"itemPromoted","item:demoted":"itemDemoted"},itemDemoted:function(item){this.trigger("item:demoted",item)},itemPromoted:function(item){this.trigger("item:promoted",item)},initialize:function(options){this.subviews=new Backbone.ChildViewContainer;this.subviews.add(new Application.View.Needle,"needle");this.on("composite:rendered",function(){this.$el.find(".scroller").scroll(_.bind(this.onScroll,this))});this.on("item:add",function(event){this.collection.add(event)});this.on("infinite:load",this.load);this.on("infinite:load",this.loading);this.on("infinite:loaded",this.loaded);this.on("infinite:failed",this.loaded);this.on("after:item:added",this.renderNeedle);this.on("item:removed",this.renderNeedle);this.on("reload",this.reload);this.on("now",this.now)},onScroll:function(event){this.trigger("scroll",event);this.subviews.findByCustom("needle").trigger("scroll",event)},onShow:function(){this.collection.fetch({data:{pid:this.model.get("pid"),status:this.model.get("status"),before:25,after:25}})},renderNeedle:function(){if(this.collection.length>0){this.$el.find(".needle-view").html(this.subviews.findByCustom("needle").render().el)}else{this.$el.find(".needle-view").empty()}},promote:function(event){var $item=$(event.currentTarget).closest("[data-id]");var model=this.collection.get($item.data("id"));model.promote();return false},demote:function(event){var $item=$(event.currentTarget).closest("[data-id]");var model=this.collection.get($item.data("id"));model.demote();return false},reload:function(){var self=this;var promise=this.collection.fetch({data:{pid:this.model.get("pid"),before:25,after:25},reset:true});promise.done(function(data){self.trigger("reload:done")});promise.fail(function(){self.trigger("reload:error")})},now:function(duration){var self=this;var promise=this.collection.now();promise.done(function(model){var $closest=self.$el.find(".item[data-id="+model.idSafe()+"]"),$needle=self.$el.find(".needle");if($closest.length===0){return}var itemPosition=$closest.position(),needlePosition=$needle.position();if(itemPosition.top===46){itemPosition.top=0}self.trigger("scrollTo",{left:itemPosition.left,top:itemPosition.top-needlePosition.top,duration:jQuery.fx.speeds.slow});$closest.addClass("now")})},load:function(options){var self=this;var data={pid:self.model.get("pid"),status:self.model.get("status")};if(options.before){data.after=0;data.before=40;data.ts=self.collection.last().get("ts")}else if(options.after){data.after=40;data.before=0;data.ts=self.collection.first().get("ts")}else{throw new Error("Invalid options provided")}self.collection.fetch({remove:false,data:data}).done(function(){self.trigger("infinite:loaded")}).fail(function(){self.trigger("infinite:failed")})},loading:function(options){this.loading=new Application.View.Loading(options);this.loading.render();this.$el.append(this.loading.$el)},loaded:function(options){this.loading.remove()},appendHtml:function(collectionView,itemView,index){var itemViewContainer=this.getItemViewContainer(collectionView);if(itemViewContainer.children().size()<=index){itemViewContainer.append(itemView.el)}else{itemViewContainer.children().eq(index).before(itemView.el)}},buildItemView:function(item,ItemViewType,itemViewOptions){var view=Backbone.Marionette.CompositeView.prototype.buildItemView.apply(this,arguments);view.model.set({status:this.model.get("status"),user:this.model.get("pid")},{silent:true});return view}});Application.View.LoadMore=Backbone.Marionette.ItemView.extend({template:"#load-more-template",className:"load-more",events:{click:"loadMore"},loadMore:function(){this.trigger("loadmore")}});Application.View.Loading=Backbone.Marionette.ItemView.extend({template:"#loading-template",className:function(options){var className="loading";if(this.options.before){className+=" before"}else if(this.options.after){className+=" after"}else{throw new Error("Invalid options provided")}return className}});Application.View.Login=Backbone.Marionette.ItemView.extend({template:"#login-template",className:"login container",events:{"keyup input":"change","submit form":"submit"},change:function(event){var target=event.target;this.model.set(target.name,target.value);var check=this.model.validateItem(target.id);if(check.isValid===false){addValidationError(target.id,check.message)}else{removeValidationError(target.id)}},submit:function(){var check=this.model.validateAll();if(check.isValid===false){displayValidationErrors(check.messages)}else{this.login(this.model.attributes)}return false},login:function(data){var self=this;Application.session.set("pid",data.pid);Application.session.set("pwd",data.pwd);Application.session.save(function(data){Backbone.history.navigate("timeline",true)},function(){})}});Application.View.Needle=Backbone.Marionette.ItemView.extend({template:"#needle-now-template",className:"needle",isRendered:false,initialize:function(options){this.on("scroll",this.scroll)},scroll:function(event){var offset=this.$el.offset();var $item=$(document.elementFromPoint(offset.left,offset.top+4)).closest(".item");if($item.length===0){return}var model=$item.data("model"),time=$item.data("model").time();if(model.isNow()===true){this.now()}else if(model.isToday()===true){this.update(time," hh:mm:ss A","Today at ")}else if(model.isEvent()===true){this.update(time,"Do MMMM YYYY")}else{this.update(time,"Do MMMM YYYY hh:mm:ss A")}this.rotate(event)},rotate:function(event){var scrollTop=$(event.target).scrollTop();this.$el.find(".icon-repeat").css({"-webkit-transform":"rotate(-"+scrollTop+"deg)","-moz-transform":"rotate(-"+scrollTop+"deg)","-o-transform":"rotate(-"+scrollTop+"deg)","-ms-transform":"rotate(-"+scrollTop+"deg)",transform:"rotate(-"+scrollTop+"deg)"})},update:function(time,format,prefix,suffix){prefix=prefix||"";suffix=suffix||"";if(this.template!=="#needle-template"){this.template="#needle-template";this.render()}var $value=this.$el.find(".value");if($value.text()!==prefix+time.format(format)+suffix){$value.text(prefix+time.format(format)+suffix)}},now:function(){this.template="#needle-now-template";this.render()},onRender:function(){this.isRendered=true}});Application.View.NoResults=Backbone.Marionette.ItemView.extend({template:"#no-results-template",className:"no-results"});Application.View.Profile=Backbone.Marionette.ItemView.extend({template:"#profile-template",className:"profile container",events:{"submit form":"submit","click .cancel":"cancel"},submit:function(){var data=$(event.target).serializeObject();
var promise=this.model.set(data).save();promise.done(function(){self.trigger("created")});promise.fail(function(){console.log("TODO: Display errors")});return false},cancel:function(){this.trigger("cancelled");return false},onShow:function(){this.model.fetch()}});Application.View.Register=Backbone.Marionette.ItemView.extend({template:"#register-template",className:"container",events:{"keyup input":"change","submit form":"submit"},change:function(event){var target=event.target;this.model.set(target.name,target.value);var check=this.model.validateItem(target.id);if(check.isValid===false){addValidationError(target.id,check.message)}else{removeValidationError(target.id)}},submit:function(){var check=this.model.validateAll();if(check.isValid===false){displayValidationErrors(check.messages)}else{this.register()}return false},register:function(){$.ajax({url:"/-taddprofile",type:"post",data:{pid:this.model.get("pid"),pwd:this.model.get("pwd"),name:this.model.get("name")},success:function(data){Backbone.history.navigate("login",true)},error:function(model,response,options){console.log("TODO: Display errors")}})}});Application.View.SearchEmpty=Backbone.Marionette.ItemView.extend({template:"#search-empty-template",className:"item empty collapsed",onShow:function(){this.$el.offset();this.$el.removeClass("collapsed")},remove:function(){var self=this,args=arguments;this.$el.transitionEnd(function(event){if(event.propertyName!=="max-height"){return}Backbone.Marionette.ItemView.prototype.remove.apply(self,args)});this.$el.addClass("collapsed")}});Application.View.SearchItem=Application.View.TimelineItem.extend({template:"#search-template",templateHelpers:{getIframeUrl:function(url){if(/youtube/.test(url)===true){return"http://www.youtube.com/embed/"+url.replace("https://gdata.youtube.com/feeds/api/videos/","")}}},className:function(){var className="item collapsed";if(this.model.get("image")){className+=" image"}if(this.model.isEvent()){className+=" event"}else if(this.model.isVideo()){className+=" video"}else if(this.model.isAudio()){className+=" audio"}if(this.model.isAdded()){className+=" added"}if(this.model.isPast()){className+=" past"}return className}});Application.View.SearchProfile=Application.View.TimelineProfile.extend({template:"#follower-template"});Application.View.Searches=Backbone.Marionette.CompositeView.extend({template:"#searches-template",events:{"click .promote":"promote"},itemViewContainer:".children",itemView:Application.View.SearchItem,emptyView:Application.View.SearchEmpty,className:function(){var className="searches";if(this.model.get("t")==="i"){className+=" items"}else{className+=" profiles"}return className},collectionEvents:{"item:promoted":"itemPromoted"},itemPromoted:function(item){this.trigger("item:promoted",item)},initialize:function(options){this.on("composite:rendered",function(){this.$el.find(".scroller").scroll(_.bind(this.onScroll,this))});this.on("reload",this.reload);this.on("now",this.now)},onScroll:function(event){this.trigger("scroll",event)},onShow:function(){var self=this;if(this.model.get("t")==="i"){this.itemView=Application.View.SearchItem}else{this.itemView=Application.View.SearchProfile}var promise=this.collection.search({data:{t:this.model.get("t"),s:this.model.get("s")}});promise.done(function(data){if(data.results.length===0){self.$el.find("span").text("No results");self.$el.find("img").remove()}});promise.fail(function(){self.$el.find("span").text("Error searching for results");self.$el.find("img").remove()})},promote:function(event){var $item=$(event.currentTarget).closest("[data-id]");var model=this.collection.get($item.data("id"));model.promote();return false},appendHtml:function(collectionView,itemView,index){var itemViewContainer=this.getItemViewContainer(collectionView);if(itemViewContainer.children().size()<=index){itemViewContainer.append(itemView.el)}else{itemViewContainer.children().eq(index).before(itemView.el)}}});Application.View.TimelinePrivate=Application.View.Timeline.extend({name:"timeline-private",className:"column private",events:{"click .header .timeline":"timeline","click .header .now":"refresh","submit .header .form":"add"},initialize:function(options){this.initialEvents();this.on("view:itemAdd",function(){this.itemAdd()})},timeline:function(){var collection=new Application.Collection.Items(undefined,{status:this.model.get("status")});var model=new Backbone.Model({pid:this.model.get("pid"),status:this.model.get("status")});var view=new Application.View.Items({collection:collection,model:model});this.bindEvents(view);this.listenTo(view,"item:demoted",function(event){this.trigger("item:demoted",event)});this.region.show(view)},itemAdd:function(){var view=new Application.View.ItemAdd({collection:this.collection,model:this.model});this.bindEvents(view);this.listenTo(view,"created",function(){this.timeline()});this.listenTo(view,"cancelled",function(){this.timeline()});this.region.show(view)},add:function(event){var $form=$(event.target);this.itemAdd();this.region.currentView.trigger("set:link",$form.find("input").val());return false},onRender:function(){this.constructor.__super__.onRender.call(this,arguments);this.timeline()}});Application.View.TimelinePublic=Application.View.Timeline.extend({name:"timeline-public",className:"column public",events:{"click .header .now":"refresh","submit .header .form":"submit"},modelEvents:{change:"render"},initialize:function(options){this.initialEvents();this.on("view:followings",function(pid){this.followings(pid)});this.on("view:followers",function(pid){this.followers(pid)});this.on("view:search",function(query){this.search(query)})},timeline:function(pid){var status;if(pid===undefined){pid=this.model.get("pid");status="p"}else{status="m"}var collection=new Application.Collection.Items(undefined,{status:status,pid:pid});var model=new Backbone.Model({pid:pid,status:status});var view=new Application.View.Items({collection:collection,model:model});this.bindEvents(view);this.listenTo(view,"item:promoted",function(event){this.trigger("item:promoted",event)});this.region.show(view)},followings:function(pid){if(pid===undefined){pid=this.model.get("pid")}var collection=new Application.Collection.Followings;var model=new Backbone.Model({pid:pid,count:20,start:10});var view=new Application.View.Followings({collection:collection,model:model});this.bindEvents(view);this.region.show(view)},followers:function(pid){if(pid===undefined){pid=this.model.get("pid")}var collection=new Application.Collection.Followers;var model=new Backbone.Model({pid:pid,count:20,start:10});var view=new Application.View.Followers({collection:collection,model:model});this.bindEvents(view);this.region.show(view)},search:function(query){var collection=new Application.Collection.Searches;var type;if(this.model.get("view")==="timeline"){type="i"}else{type="p"}var model=new Backbone.Model({s:query,t:type});var view=new Application.View.Searches({collection:collection,model:model});this.bindEvents(view);this.region.show(view)},submit:function(event){var url="search/"+$(event.target).find("[type=search]").val();Backbone.history.navigate(url,true);return false},onRender:function(){this.constructor.__super__.onRender.call(this,arguments);var self=this;this.region.show=function(view){var $timeline=self.$el.children();var viewClass;if(view.id!==undefined){viewClass=view.id}else{viewClass=_.result(view,"className").split(" ")[0]}$timeline.attr("class",function(index,className){return className.replace(/\s*view-[^\s]+\s*/g,"")});$timeline.addClass("view-"+viewClass);var $navigation=self.$el.find(".nav > li");$navigation.removeClass("active");$navigation.filter("."+viewClass).addClass("active");return Backbone.Marionette.Region.prototype.show.apply(this,arguments)}}});Application.View.Timelines=Backbone.Marionette.ItemView.extend({name:"timelines",template:"#timelines-template",className:"container-wide timelines",initialize:function(options){this.initViews();this.initEvents()},initViews:function(){this.subviews=new Backbone.ChildViewContainer;var publicTimeline=new Application.View.TimelinePublic({model:new Backbone.Model({pid:this.options.public.pid,view:this.options.public.view,status:"p"})});this.subviews.add(publicTimeline,"publicTimeline");var privateTimeline=new Application.View.TimelinePrivate({model:new Backbone.Model({pid:this.options.private.pid,view:this.options.private.view,status:"m"})});this.subviews.add(privateTimeline,"privateTimeline")},initEvents:function(){var publicTimeline=this.subviews.findByCustom("publicTimeline"),privateTimeline=this.subviews.findByCustom("privateTimeline");this.listenTo(publicTimeline,"item:promoted",function(items){if(_.isArray(items)===false){items=[items]}_.each(items,function(item){privateTimeline.trigger("item:add",item)})});this.listenTo(privateTimeline,"item:created",function(event){privateTimeline.trigger("item:add",event)});this.on("public:followings",function(pid){publicTimeline.trigger("view:followings",pid)});this.on("public:followers",function(pid){publicTimeline.trigger("view:followers",pid)});this.on("public:timeline",function(pid){publicTimeline.trigger("view:timeline",pid)});this.on("public:search",function(query){publicTimeline.trigger("view:search",query)});this.on("private:itemAdd",function(){privateTimeline.trigger("view:itemAdd")});this.on("private:timeline",function(){privateTimeline.trigger("view:timeline")})},onRender:function(){var publicTimeline=this.subviews.findByCustom("publicTimeline"),privateTimeline=this.subviews.findByCustom("privateTimeline");this.$el.find(".timeline-public").replaceWith(publicTimeline.render().el);this.$el.find(".timeline-private").replaceWith(privateTimeline.render().el)}});Application.Router.Admin=Backbone.Router.extend({_currentView:null,routes:{login:"login",logout:"logout","profile/new":"profileNew","profile/:pid/edit":"profileEdit","profile/:pid":"profileView","profile/:pid/following":"following","profile/:pid/followers":"followers","profile/:pid/feeds":"feeds","addfeed/:pid":"addfeed","*default":"home"},initialize:function(){var header=new Application.View.Header({model:new Backbone.Model({pid:Application.session.get("pid")})});Application.header.show(header)},login:function(){var login=new Application.View.Login({model:new Application.Model.Credentials});Application.content.show(login)},home:function(){var self=this;var check=Application.session.check();check.done(function(){var home=new Application.Admin.View.Home({model:new Backbone.Model({pid:Application.session.get("pid"),message:undefined})});Application.content.show(home)});check.fail(function(){Backbone.history.navigate("login",true)})},profileView:function(pid){var self=this;var check=Application.session.check();check.done(function(){var profile=new Application.Model.Profile({pid:pid});profile.fetch().done(function(){var items=new ProfileItems({pid:pid});items.fetch().done(function(){if(profile.get("parentpid")){self.changePage(new FeedView({model:profile,items:items}))}else{var view=new Application.Admin.View.ProfileView({model:new Backbone.Model({model:profile,items:items})});Application.content.show(view)}}).fail(function(){var view=new Application.Admin.View.Home({model:new Backbone.Model({message:"Problem retrieving profile items for '"+pid+"'"})});Application.content.show(view)})}).fail(function(){var view=new Application.Admin.View.Home({model:new Backbone.Model({message:"Problem retrieving profile '"+pid+"'"})});Application.content.show(view)})});check.fail(function(){self.invalidSession()})},following:function(pid){var self=this;Application.session.check(function(){var list=new FollowingList({pid:pid});list.fetch({success:function(){self.changePage(new FollowingListView({collection:list}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},followers:function(pid){var self=this;Application.session.check(function(){var list=new FollowersList({pid:pid});list.fetch({success:function(){self.changePage(new FollowersListView({collection:list}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},feeds:function(pid){var self=this;Application.session.check(function(){var list=new Application.Collection.Feeds({pid:pid});list.fetch({success:function(){self.changePage(new FeedsListView({collection:list}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},profileEdit:function(pid){var self=this;Application.session.check(function(){var profile=new Profile({pid:pid});profile.fetch({success:function(){if(profile.get("parentpid")){self.changePage(new EditFeedView({model:profile}))}else{self.changePage(new EditProfileView({model:profile}))}},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},profileNew:function(){var self=this;var check=Application.session.check();check.done(function(){Application.content.show(new Application.Admin.View.ProfileNew)});check.fail(function(){Backbone.history.navigate("login",true)})},addfeed:function(pid){var self=this;Application.session.check(function(){var profile=new Profile({pid:pid});profile.fetch({success:function(){self.changePage(new AddFeedView({model:profile}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},invalidSession:function(){self.changePage(new StaticView({name:"Application.session"}))}});Application.Router.User=Backbone.Router.extend({routes:{login:"login",logout:"logout",register:"register",timeline:"timeline",followings:"followings",followers:"followers",profile:"profile","user/:id":"timeline","followers/:id":"followers","followings/:id":"followings","search/:query":"search"},initialize:function(){this.header=new Application.View.Header({model:new Backbone.Model({pid:Application.session.get("pid"),wide:false})});Application.header.show(this.header)},timeline:function(pid){var self=this;var check=Application.session.check();check.done(function(){self.header.model.set("wide",true);self.header.render();if(pid===Application.session.get("pid")){pid=undefined}var timeline=new Application.View.Timelines({"public":{pid:Application.session.get("pid"),view:"timeline"},"private":{pid:Application.session.get("pid"),view:"timeline"}});if(Application.content.is("timelines")===true){Application.content.currentView.trigger("public:timeline",pid)}else{Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},search:function(query){var self=this;var check=Application.session.check();check.done(function(){self.header.model.set("wide",true);self.header.render();var timeline=new Application.View.Timelines({"public":{pid:Application.session.get("pid"),view:"search"},"private":{pid:Application.session.get("pid"),view:"timeline"}});if(Application.content.is("timelines")===true){Application.content.currentView.trigger("public:search",query)}else{Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},followers:function(pid){var self=this;var check=Application.session.check();check.done(function(){self.header.model.set("wide",true);self.header.render();if(pid===undefined){pid=Application.session.get("pid")}var timeline=new Application.View.Timelines({"public":{pid:pid,view:"followers"},"private":{pid:Application.session.get("pid"),view:"timeline"}});if(Application.content.is("timelines")){Application.content.currentView.trigger("public:followers",pid)}else{Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},followings:function(pid){var self=this;var check=Application.session.check();check.done(function(){self.header.model.set("wide",true);self.header.render();if(pid===undefined){pid=Application.session.get("pid")}var timeline=new Application.View.Timelines({"public":{pid:pid,view:"followings"},"private":{pid:Application.session.get("pid"),view:"timeline"}});if(Application.content.is("timelines")){Application.content.currentView.trigger("public:followings",pid)}else{Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},profile:function(){var self=this;var check=Application.session.check();check.done(function(){var profile=new Application.View.Profile({model:new Application.Model.Profile({pid:Application.session.get("pid")})});Application.content.show(profile)});check.fail(function(){Backbone.history.navigate("login",true)})},login:function(){var login=new Application.View.Login({model:new Application.Model.Credentials});Application.content.show(login)},register:function(){var register=new Application.View.Register({model:new Application.Model.RegistrationInfo});Application.content.show(register)},logout:function(){Application.session.destroy();Backbone.history.navigate("login",true)}});
//@ sourceMappingURL=/-assets/javascripts/application/source-map.js