var Application=new Backbone.Marionette.Application;Application.Admin={Model:{},View:{},Collection:{},Router:{}};Application.Model={};Application.View={};Application.Collection={};Application.Router={};Application.addRegions({header:"body > .header",content:"body > .content",footer:"body > .footer"});Backbone.Marionette.Region.prototype.is=function(view){if(this.currentView===view){return true}else if(this.currentView===undefined){return false}else if(this.currentView.name===view){return true}else{return false}};Application.addInitializer(function(options){Application.session=new Application.Model.Session;var cookie=$.cookie("ptsession");if(cookie){Application.session.set("ptsession",cookie)}});Application.addInitializer(function(options){if(options.router==="admin"){Application.router=new Application.Router.Admin}else{Application.router=new Application.Router.User}});Application.addInitializer(function(){var closeBtn='<a title="Close" class="fancybox-item fancybox-close">';closeBtn+='<i class="icon-remove-circle"></i>';closeBtn+="</a>";$(".fancybox").fancybox({maxWidth:970,maxHeight:800,fitToView:false,width:"70%",height:"90%",autoSize:false,closeClick:false,openEffect:"none",closeEffect:"none",arrows:false,tpl:{closeBtn:closeBtn}})});Application.on("initialize:after",function(options){Backbone.history.start({root:"/"})});Application.on("initialize:after",function(options){Application.session.check(function(){if(Application.router.routes[Backbone.history.fragment]===true){return}Backbone.history.navigate("timeline",true)},function(){if(["login","register"].indexOf(Backbone.history.fragment)!==-1){return}else{Backbone.history.navigate("login",true)}})});function hashCode(){var hash=0,i,char;if(this.length==0)return hash;for(i=0;i<this.length;i++){char=this.charCodeAt(i);hash=(hash<<5)-hash+char;hash=hash&hash}return hash}function displayValidationErrors(messages){for(var key in messages){if(messages.hasOwnProperty(key)){addValidationError(key,messages[key])}}}function addValidationError(field,message){var controlGroup=$("#"+field).parent();controlGroup.addClass("error");$(".hint",controlGroup).html(message)}function removeValidationError(field){var controlGroup=$("#"+field).parent();controlGroup.removeClass("error");$(".hint",controlGroup).html("")}Application.Model.Credentials=Backbone.Model.extend({defaults:{pid:null,pwd:null},url:"/-session",initialize:function(){this.validators={};this.validators.pid=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your username."}};this.validators.pwd=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your password."}}},validateItem:function(key){return this.validators[key]?this.validators[key](this.get(key)):{isValid:true}},validateAll:function(){var messages={};for(var key in this.validators){if(this.validators.hasOwnProperty(key)){var check=this.validators[key](this.get(key));if(check.isValid===false){messages[key]=check.message}}}return _.size(messages)>0?{isValid:false,messages:messages}:{isValid:true}}});Application.Model.Feed=Backbone.Model.extend({});Application.Model.Item=Backbone.Model.extend({idAttribute:"uid",defaults:{now:false},initialize:function(){this.set("uid",this.get("id")+"-"+this.get("ts"),{silent:true})},idSafe:function(){return this.id.replace(/@/,"\\@")},time:function(){return moment.unix(this.get("ts").toString().substr(0,10))},save:function(done,fail){var promise=$.ajax({url:"/-tadd",type:"post",data:{pid:Application.session.get("pid"),link:this.get("link"),text:this.get("text"),ets:this.get("ets")}});promise.done(done);promise.fail(fail);return promise},promote:function(done,fail){var defer=$.Deferred();defer.done(done);defer.fail(fail);this.trigger("item:promoted",this.attributes);$.ajax({url:"/-tpromote",type:"post",data:{pid:Application.session.get("pid"),id:this.get("id")},success:function(){defer.resolve()},failure:function(){defer.reject()}});return defer.promise()},demote:function(done,fail){var defer=$.Deferred();defer.done(done);defer.fail(fail);this.trigger("item:demoted",this);$.ajax({url:"/-tdemote",type:"post",data:{pid:Application.session.get("pid"),id:this.get("id")},success:function(){defer.resolve()},failure:function(){defer.reject()}});return defer.promise()}});Application.Model.Profile=Backbone.Model.extend({defaults:{bio:false},idAttribute:"pid",url:function(){return"/-jpr?pid="+this.get("pid")},follow:function(done,fail){var defer=$.Deferred();defer.done(done);defer.fail(fail);this.collection.trigger("profile:follow",this.attributes);this.trigger("follow",this.attributes);$.ajax({url:"/-tfollow",type:"post",data:{pid:Application.session.get("pid"),followpid:this.get("pid")},success:function(){defer.resolve()},failure:function(){defer.reject()}});return defer.promise()},unfollow:function(done,fail){var defer=$.Deferred();defer.done(done);defer.fail(fail);this.collection.trigger("profile:unfollow",this.attributes);this.collection.remove(this);this.trigger("unfollow",this.attributes);$.ajax({url:"/-tunfollow",type:"post",data:{pid:Application.session.get("pid"),followpid:this.get("pid")},success:function(){defer.resolve()},failure:function(){defer.reject()}});return defer.promise()}});Application.Model.RegistrationInfo=Backbone.Model.extend({defaults:{pid:null,pwd:null,name:null},url:"/-session",initialize:function(){this.validators={};this.validators.pid=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your username."}};this.validators.pwd=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your password."}};this.validators.name=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your full name."}}},validateItem:function(key){return this.validators[key]?this.validators[key](this.get(key)):{isValid:true}},validateAll:function(){var messages={};for(var key in this.validators){if(this.validators.hasOwnProperty(key)){var check=this.validators[key](this.get(key));if(check.isValid===false){messages[key]=check.message}}}return _.size(messages)>0?{isValid:false,messages:messages}:{isValid:true}}});Application.Model.Session=Backbone.Model.extend({initialize:function(){var cookie=$.cookie("ptsession");if(cookie!==undefined){this.set("pid",cookie.split("|")[0])}},check:function(done,fail){var self=this;var defer=$.Deferred();defer.done(done);defer.fail(fail);if(this.get("ptsession")){$.ajax({url:"/-chksession"}).done(function(){var cookie=$.cookie("ptsession");if(cookie!==undefined){self.set("pid",cookie.split("|")[0])}defer.resolve()}).fail(function(){self.set("pid",null);defer.reject()})}else{defer.reject()}return defer.promise()},save:function(done,fail){var self=this;var defer=$.Deferred();defer.done(done);defer.fail(fail);$.ajax({url:"/-session",type:"post",data:{pid:self.get("pid"),pwd:self.get("pwd")}}).done(function(data){self.set("pwd",null);self.set("ptsession",$.cookie("ptsession"));defer.resolve(data)}).fail(function(data){self.set("pwd",null);defer.fail(data)});return defer.promise()},destroy:function(){$.cookie("ptsession",null);Backbone.Model.prototype.destroy.apply(this)}});Application.Collection.Feeds=Backbone.Collection.extend({model:Application.Model.Feed,initialize:function(options){this.pid=options.pid},url:function(){return"/-jfeeds?pid="+this.pid}});Application.Collection.Followers=Backbone.Collection.extend({model:Application.Model.Profile,url:"/-jfollowers"});Application.Collection.Followings=Backbone.Collection.extend({model:Application.Model.Profile,url:"/-jfollowing"});Application.Collection.Items=Backbone.Collection.extend({model:Application.Model.Item,url:"/-jtl",initialize:function(collection,options){this.options=options;this.on("item:demoted",function(target){var models=this.filter(function(item){return item.get("id")===target.get("id")});this.remove(models)})},fetch:function(options){options.data=_.extend(this.options,options.data);return Backbone.Collection.prototype.fetch.call(this,options)},now:function(){var self=this;var options={data:{pid:this.options.pid,status:this.options.status},remove:false};var defer=$.Deferred();Backbone.Collection.prototype.fetch.call(this,options).done(function(data){if(data.length===0){defer.reject()}else{self.each(function(model){model.set("now",false)});var model=self.get(data[0].id+"-"+data[0].ts);model.set("now",true);defer.resolve(model)}}).fail(function(){defer.reject()});return defer.promise()},comparator:function(model){return-model.get("ts")}});var ProfileItems=Backbone.Collection.extend({model:Application.Model.Item,initialize:function(options){this.pid=options.pid},url:function(){return"/-jtl?status=m&count=30&pid="+this.pid}});Application.View.Timeline=Backbone.Marionette.ItemView.extend({name:"timeline",template:"#timeline-template",className:"column",initEvents:function(){$(window).on("resize",this.resizeScroller.bind(this));this.on("item:add",function(event){this.region.currentView.trigger("item:add",event)});this.on("view:timeline",function(){this.region.show(this.subviews.findByCustom("timeline"))});this.subviews.each(function(view){if(view.noScroller===true){return}this.listenTo(view,"after:item:added",this.refreshScroller);this.listenTo(view,"item:removed",this.refreshScroller);this.listenTo(view,"show",this.bindScroller);this.listenTo(view,"show",this.resizeScroller);this.listenToOnce(view,"show",function(){var self=this;setTimeout(function(){self.now()},jQuery.fx.speeds.slow+500)});this.listenTo(view,"composite:collection:rendered",this.refreshScroller);this.listenTo(view,"infinite:loaded",function(){this.refreshScroller();this.infiniteScrollLoading=false});this.listenTo(view,"scroll:to",function(event){this.iscroll.scrollTo(event.left,event.top,event.duration)})},this)},onRender:function(){this.region=new Backbone.Marionette.Region({el:this.$el.find(".collection")})},bindScroller:function(){var self=this;if(this.iscroll){this.iscroll.destroy()}var $scroller=this.$el.find(".scroller");this.iscroll=new iScroll($scroller.get(0),{momentum:true,hScrollbar:false,hScroll:false,vScroll:true,vScrollbar:true,scrollbarClass:"scrollbar",onScrollEnd:function(event){self.infiniteScroll(this);if(self.region.currentView!==undefined){self.region.currentView.trigger("scroll",this)}}});return this},resizeScroller:function(event){var $scroller=this.$el.find(".scroller");$scroller.height($(window).height()-59)},refreshScroller:function(){var self=this;if(this.iscroll===undefined){return}clearTimeout(self.scrollerTimeout);self.scrollerTimeout=setTimeout(function(){self.iscroll.refresh()},jQuery.fx.speeds.slow+250)},infiniteScroll:function(event){var self=this;clearTimeout(self.infiniteScrollReference);self.infiniteScrollReference=setTimeout(function(){if(self.infiniteScrollLoading===true){return}else if(Math.abs(event.y)<140*5){self.region.currentView.trigger("infinite:load",{after:true})}else if(Math.abs(event.y)>Math.abs(event.maxScrollY+140*5)){self.region.currentView.trigger("infinite:load",{before:true})}else{return}},150)}});var BriefFeedView=Backbone.View.extend({initialize:function(options){this.template=_.template($("#brieffeed-tmpl").html())},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));return this}});var BriefItemView=Backbone.View.extend({initialize:function(options){this.template=_.template($("#briefitem-tmpl").html())},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));return this}});Application.View.ProfileBrief=Backbone.Marionette.ItemView.extend({template:"#briefprofile-tmpl"});var AddFeedView=Backbone.View.extend({events:{"click .saveBtn":"save"},initialize:function(options){this.template=_.template($("#addfeed-tmpl").html())},save:function(){var self=this;$.ajax({url:"/-taddprofile",type:"post",data:{pid:this.model.get("pid")+"~"+$("#feedpid").val(),pname:$("#pname").val(),parentpid:this.model.get("pid"),feedurl:$("#feedurl").val()},success:function(data){Backbone.history.navigate("profile/"+self.model.get("pid"),true)}});return false},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));return this}});var EditFeedView=Backbone.View.extend({events:{"click .saveBtn":"save"},initialize:function(options){this.template=_.template($("#editfeed-tmpl").html())},save:function(){var self=this;$.ajax({url:"/-tupdateprofile",type:"post",data:{pid:this.model.get("pid"),pname:$("#pname").val(),parentpid:$("#parentpid").val(),feedurl:$("#feedurl").val()},success:function(data){Backbone.history.navigate("profile/"+self.model.get("pid"),true)}});return false},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));return this}});var FeedView=Backbone.View.extend({events:{"click .editBtn":"edit","click .refreshBtn":"refresh","click .deleteBtn":"delete"},initialize:function(options){this.template=_.template($("#feed-tmpl").html());this.msg="";this.initItemViews(options.items)},edit:function(){Backbone.history.navigate("editprofile/"+this.model.get("pid"),true);return false},refresh:function(){var self=this;$.ajax({url:"/-refresh",type:"get",data:{pid:self.model.get("pid")},success:function(data){var items=new ProfileItems({pid:self.model.get("pid")});items.fetch({success:function(){self.initItemViews(items);self.msg="";self.render()},error:function(request,status,error){self.msg="There was a problem displaying feed items: "+request.responseText;self.render()}})},error:function(request,status,error){self.msg="There was a problem refreshing feed items: "+request.responseText;self.render()}});return false},"delete":function(){var self=this;$.ajax({url:"/-tremprofile",type:"post",data:{pid:self.model.get("pid")},success:function(){Backbone.history.navigate("profile/"+self.model.get("parentpid"),true)},error:function(request,status,error){self.msg="There was a problem deleting the feed: "+request.responseText;self.render()}});return false},initItemViews:function(items){this._views=[];var self=this;items.each(function(m){self._views.push(new BriefItemView({model:m}))})},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));$(".msg",this.el).html(this.msg);var self=this;_(this._views).each(function(v){$(".items",self.el).append(v.render().el)});return this}});var FeedsListView=Backbone.View.extend({initialize:function(options){var self=this;this.template=_.template($("#feeds-tmpl").html());this._views=[];this.collection.each(function(m){self._views.push(new BriefFeedView({model:m}))})},render:function(){var self=this;$(this.el).html(this.template({data:{pid:this.collection.pid}}));_(this._views).each(function(v){$(self.el).append(v.render().el)});return this}});Application.Admin.View.Followers=Backbone.Marionette.CollectionView.extend({template:"#followers-tmpl",itemView:Application.Admin.View.FollowerBrief});Application.Admin.View.Following=Backbone.Marionette.CollectionView.extend({template:"#following-tmpl",itemView:Application.View.ProfileBrief});Application.Admin.View.Home=Backbone.Marionette.ItemView.extend({template:"#home-template",className:"container",events:{"submit form":"profile"},profile:function(){var url="profile/"+this.$el.find("input[name=pid]").val();Backbone.history.navigate(url,true);return false}});var AddProfileView=Backbone.View.extend({events:{"click .saveBtn":"save"},initialize:function(options){this.template=_.template($("#addprofile-tmpl").html())},save:function(){var self=this;$.ajax({url:"/-taddprofile",type:"post",data:{pid:$("#pid").val(),pname:$("#pname").val(),pwd:$("#pwd").val(),bio:$("#bio").val()},success:function(data){Backbone.history.navigate("profile/"+$("#pid").val(),true)}});return false},render:function(){$(this.el).html(this.template());return this}});var EditProfileView=Backbone.View.extend({events:{"click .saveBtn":"save"},initialize:function(options){this.template=_.template($("#editprofile-tmpl").html())},save:function(){var self=this;$.ajax({url:"/-tupdateprofile",type:"post",data:{pid:this.model.get("pid"),bio:$("#bio").val(),pname:$("#pname").val(),parentpid:$("#parentpid").val(),feedurl:$("#feedurl").val()},success:function(data){Backbone.history.navigate("profile/"+self.model.get("pid"),true)}});return false},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));return this}});Application.Admin.View.ProfileView=Backbone.View.extend({events:{"click .editBtn":"edit","click .feedBtn":"addfeed"},initialize:function(options){this.template=_.template($("#profile-tmpl").html());this._views=[];var self=this;options.items.each(function(m){self._views.push(new BriefItemView({model:m}))})},edit:function(){Backbone.history.navigate("editprofile/"+this.model.get("pid"),true);return false},addfeed:function(){Backbone.history.navigate("addfeed/"+this.model.get("pid"),true);return false},render:function(){$(this.el).html(this.template({data:this.model.toJSON()}));var self=this;_(this._views).each(function(v){$(".items",self.el).append(v.render().el)});return this}});var StaticView=Backbone.View.extend({initialize:function(options){this.template=_.template($("#"+options.name+"-tmpl").html())},render:function(){$(this.el).html(this.template());return this}});Application.View.Follower=Backbone.Marionette.ItemView.extend({template:"#follower-template",className:"item",attributes:function(){return{"data-pid":this.model.get("pid")}},onBeforeRender:function(){this.$el.css({opacity:0,maxHeight:0,paddingTop:0,paddingBottom:0,marginBottom:0})},onRender:function(){this.$el.data("model",this.model);this.$el.animate({maxHeight:140,opacity:1,paddingTop:15,paddingBottom:15,marginBottom:7},"slow",function(){$(this).css("max-height","auto")})},remove:function(){this.$el.animate({opacity:0,maxHeight:0,paddingTop:0,paddingBottom:0,marginBottom:0},"slow",function(){$(this).remove();$(this).css("max-height","auto")});this.stopListening();return this}});Application.View.Followers=Backbone.Marionette.CompositeView.extend({template:"#followers-template",className:"followers",itemView:Application.View.Follower,itemViewContainer:".children",events:{"click .unfollow":"unfollow","click .follow":"follow"},initialize:function(options){this.on("infinite:load",this.loadMore)},onRender:function(){this.collection.fetch({data:{pid:this.model.get("pid"),count:this.model.get("count")},reset:true})},follow:function(event){var $profile=$(event.currentTarget).closest("[data-pid]");var model=this.collection.get($profile.data("pid"));model.follow()},unfollow:function(event){var $profile=$(event.currentTarget).closest("[data-pid]");var model=this.collection.get($profile.data("pid"));model.unfollow()},loadMore:function(options){if(options.before){return}var self=this;var data={pid:self.model.get("pid"),start:self.model.get("start"),count:10};self.collection.fetch({remove:false,data:data}).done(function(data){if(data.length>0){self.model.set("start",data.start+10)}self.trigger("infinite:loaded")}).fail(function(){self.trigger("infinite:failed")})}});Application.View.Following=Backbone.Marionette.ItemView.extend({template:"#following-template",className:"item",attributes:function(){return{"data-pid":this.model.get("pid")}},onBeforeRender:function(){this.$el.css({opacity:0,maxHeight:0,paddingTop:0,paddingBottom:0,marginBottom:0})},onRender:function(){this.$el.data("model",this.model);this.$el.animate({maxHeight:140,opacity:1,paddingTop:15,paddingBottom:15,marginBottom:7},"slow",function(){$(this).css("max-height","auto")})},remove:function(){this.$el.animate({opacity:0,maxHeight:0,paddingTop:0,paddingBottom:0,marginBottom:0},"slow",function(){$(this).remove();$(this).css("max-height","auto")});this.stopListening();return this}});Application.View.Followings=Backbone.Marionette.CompositeView.extend({template:"#followers-template",className:"followings",itemView:Application.View.Following,itemViewContainer:".children",events:{"click .unfollow":"unfollow"},initialize:function(options){this.on("infinite:load",this.loadMore)},onRender:function(){this.collection.fetch({data:{pid:this.model.get("pid"),count:this.model.get("count")},reset:true})},unfollow:function(event){var $profile=$(event.currentTarget).closest("[data-pid]");var model=this.collection.get($profile.data("pid"));model.unfollow()},loadMore:function(options){if(options.before){return}var self=this;var data={pid:self.model.get("pid"),start:self.model.get("start"),count:10};self.collection.fetch({remove:false,data:data}).done(function(data){if(data.length>0){self.model.set("start",data.start+10)}self.trigger("infinite:loaded")}).fail(function(){self.trigger("infinite:failed")})}});Application.View.Header=Backbone.Marionette.ItemView.extend({template:"#header-template",className:"navbar navbar-fixed",initialize:function(options){}});Application.View.ItemAdd=Backbone.Marionette.ItemView.extend({template:"#item-add-template",className:"item",events:{"keyup input":"change","submit form":"submit","click .cancel":"cancel"},noScroller:true,initialize:function(options){this.model=new Application.Model.Item({link:"",text:"",ets:""});this.on("set:link",function(value){this.model.set("link",value)});this.on("set:text",function(value){this.model.set("text",value)});this.on("set:ets",function(value){this.model.set("ets",value)})},change:function(event){this.model.set(event.target.name,event.target.value)},submit:function(){var self=this;var promise=this.model.save();promise.done(function(){self.trigger("created")});promise.fail(function(){console.log("TODO: Display errors")});return false},cancel:function(){this.trigger("cancelled");return false}});Application.View.ItemEmpty=Backbone.Marionette.ItemView.extend({template:"#item-empty-template",className:"item empty",onBeforeRender:function(){this.$el.css({opacity:0,maxHeight:0,paddingTop:0,paddingBottom:0,marginBottom:0})},onRender:function(){this.$el.data("model",this.model);this.$el.animate({maxHeight:140,opacity:1,paddingTop:15,paddingBottom:15,marginBottom:7},"slow",function(){$(this).css("max-height","auto")})},remove:function(){this.$el.animate({opacity:0,maxHeight:0,paddingTop:0,paddingBottom:0,marginBottom:0},"slow",function(){$(this).remove();$(this).css("max-height","auto")});this.stopListening();return this}});Application.View.Item=Backbone.Marionette.ItemView.extend({template:"#item-template",modelEvents:{"item:promoted":"onPromoted"},attributes:function(){var attributes={"data-id":this.model.id};if(this.model.get("image")){attributes.style="background-image: url(/-img/"+this.model.get("image")+")"}return attributes},className:function(){var className="item";if(this.model.get("image")){className+=" image"}if(this.model.get("event")==this.model.get("ts").toString().substr(0,10)){className+=" event"}return className},onPromoted:function(){this.$el.removeClass("now").addClass("promoted")},onBeforeRender:function(){this.$el.css({opacity:0,maxHeight:0,paddingTop:0,paddingBottom:0,marginBottom:0})},onRender:function(){this.$el.data("model",this.model);this.$el.animate({maxHeight:150,opacity:1,paddingTop:15,paddingBottom:15,marginBottom:7},"slow",function(){$(this).css("max-height","auto")})},remove:function(){this.$el.animate({opacity:0,maxHeight:0,paddingTop:0,paddingBottom:0,marginBottom:0},"slow",function(){$(this).remove();$(this).css("max-height","auto")});this.stopListening();return this}});Application.View.Items=Backbone.Marionette.CompositeView.extend({template:"#items-template",className:"items",events:{"click .promote":"promote","click .demote":"demote"},itemViewContainer:".children",itemView:Application.View.Item,emptyView:Application.View.ItemEmpty,collectionEvents:{"item:promoted":"itemPromoted","item:demoted":"itemDemoted"},itemDemoted:function(item){this.trigger("item:demoted",item)},itemPromoted:function(item){this.trigger("item:promoted",item)},initialize:function(options){this.subviews=new Backbone.ChildViewContainer;this.subviews.add(new Application.View.Needle,"needle");this.on("item:add",function(event){this.collection.add(event)});this.on("scroll",function(event){this.subviews.findByCustom("needle").trigger("scroll",event)});this.on("infinite:load",this.loadMore);this.on("after:item:added",this.renderNeedle);this.on("item:removed",this.renderNeedle);this.on("refresh",this.refresh)},onShow:function(){var promise=this.collection.fetch({data:{pid:this.model.get("pid"),before:20,after:20}})},renderNeedle:function(){if(this.collection.length>0){this.$el.find(".needle-view").html(this.subviews.findByCustom("needle").render().el)}else{this.$el.find(".needle-view").empty()}},promote:function(event){var $item=$(event.currentTarget).closest("[data-id]");var model=this.collection.get($item.data("id"));model.promote();return false},demote:function(event){var $item=$(event.currentTarget).closest("[data-id]");var model=this.collection.get($item.data("id"));model.demote();return false},refresh:function(){var promise=this.collection.fetch({data:{pid:this.model.get("pid"),before:20,after:20},remove:true});promise.done(this.renderNeedle.bind(this));promise.done(this.now.bind(this))},now:function(){var self=this;var promise=this.collection.now();promise.done(function(model){var $closest=self.$el.find(".item[data-id="+model.idSafe()+"]"),$needle=self.$el.find(".needle");var position=$closest.position(),offset=$needle.position();self.off("scroll");self.trigger("scroll:to",{left:-position.left,top:-(position.top-offset.top),duration:jQuery.fx.speeds.slow});setTimeout(function(){self.on("scroll",function(event){self.subviews.findByCustom("needle").trigger("scroll",event)})},jQuery.fx.speeds.slow+250);$closest.addClass("now")})},loadMore:function(options){var self=this;var data={pid:self.model.get("pid"),status:self.model.get("status")};if(options.before){data.after=0;data.before=10;data.ts=self.collection.last().get("ts")}else if(options.after){data.after=10;data.before=0;data.ts=self.collection.first().get("ts")}else{throw new Error("Invalid options provided")}self.collection.fetch({remove:false,data:data}).done(function(){self.trigger("infinite:loaded")}).fail(function(){self.trigger("infinite:failed")})},appendHtml:function(collectionView,itemView,index){var itemViewContainer=this.getItemViewContainer(collectionView);if(itemViewContainer.children().size()<=index){itemViewContainer.append(itemView.el)}else{itemViewContainer.children().eq(index).before(itemView.el)}},buildItemView:function(item,ItemViewType,itemViewOptions){var view=Backbone.Marionette.CompositeView.prototype.buildItemView.apply(this,arguments);view.model.set("status",this.model.get("status"),{silent:true});return view}});Application.View.LoadMore=Backbone.Marionette.ItemView.extend({template:"#load-more-template",className:"load-more",events:{click:"loadMore"},loadMore:function(){this.trigger("loadmore")}});Application.View.Login=Backbone.Marionette.ItemView.extend({template:"#login-template",className:"login container",events:{"keyup input":"change","submit form":"submit"},change:function(event){var target=event.target;this.model.set(target.name,target.value);var check=this.model.validateItem(target.id);if(check.isValid===false){addValidationError(target.id,check.message)}else{removeValidationError(target.id)}},submit:function(){var check=this.model.validateAll();if(check.isValid===false){displayValidationErrors(check.messages)}else{this.login(this.model.attributes)}return false},login:function(data){var self=this;Application.session.set("pid",data.pid);Application.session.set("pwd",data.pwd);Application.session.save(function(data){Backbone.history.navigate("timeline",true)},function(){})}});Application.View.NeedleNow=Backbone.Marionette.ItemView.extend({template:"#needle-now-template",initialize:function(options){this.on("scroll",this.scroll)}});Application.View.Needle=Backbone.Marionette.ItemView.extend({template:"#needle-template",className:"needle",isRendered:false,initialize:function(options){this.on("scroll",this.scroll)},scroll:function(){var offset=this.$el.offset();var $item=$(document.elementFromPoint(offset.left,offset.top+4)).closest(".item");if($item.length===0){return}var model=$item.data("model"),time=$item.data("model").time();if(model.get("now")===true){this.now()}else if(Math.abs(time.diff())<moment().add("day",1).diff()){this.update(time," hh:mm:ss A","Today at ")}else{this.update(time,"Do MMMM YYYY")}},update:function(time,format,prefix,suffix){prefix=prefix||"";suffix=suffix||"";this.$el.find(".date").text(prefix+time.format(format)+suffix)},now:function(){var now=new Application.View.NeedleNow;now.render();this.$el.html(now.el)},onRender:function(){this.isRendered=true}});Application.View.NoResults=Backbone.Marionette.ItemView.extend({template:"#no-results-template",className:"no-results"});Application.View.Register=Backbone.Marionette.ItemView.extend({template:"#register-template",className:"container",events:{"keyup input":"change","submit form":"submit"},change:function(event){var target=event.target;this.model.set(target.name,target.value);var check=this.model.validateItem(target.id);if(check.isValid===false){addValidationError(target.id,check.message)}else{removeValidationError(target.id)}},submit:function(){var check=this.model.validateAll();if(check.isValid===false){displayValidationErrors(check.messages)}else{this.register()}return false},register:function(){$.ajax({url:"/-taddprofile",type:"post",data:{pid:this.model.get("pid"),pwd:this.model.get("pwd"),name:this.model.get("name")},success:function(data){Backbone.history.navigate("login",true)},error:function(model,response,options){console.log("TODO: Display errors")}})}});Application.View.TimelinePrivate=Application.View.Timeline.extend({name:"timeline-private",className:"column private",events:{"click .header .timeline":"timeline","click .header .now":"now","submit .header .form":"add"},initialize:function(options){this.initSubviews();this.initEvents()},initSubviews:function(){this.subviews=new Backbone.ChildViewContainer;this.initTimeline();this.initAddItem()},initTimeline:function(){var collection=new Application.Collection.Items(undefined,{status:this.model.get("status")});var model=new Backbone.Model({pid:this.model.get("pid"),status:this.model.get("status")});var view=new Application.View.Items({collection:collection,model:model});this.subviews.add(view,"timeline")},initAddItem:function(){this.subviews.add(new Application.View.ItemAdd,"itemAdd")},initEvents:function(){this.constructor.__super__.initEvents.call(this,arguments);var timeline=this.subviews.findByCustom("timeline"),itemAdd=this.subviews.findByCustom("itemAdd");this.listenTo(timeline,"item:demoted",function(event){this.trigger("item:demoted",event)});this.listenTo(itemAdd,"created",function(){this.region.show(timeline)});this.listenTo(itemAdd,"cancelled",function(){this.region.show(timeline)});this.on("view:itemAdd",function(){this.region.show(itemAdd)})},timeline:function(){this.region.show(this.subviews.findByCustom("timeline"))},itemAdd:function(){this.region.show(this.subviews.findByCustom("itemAdd"))},now:function(){this.region.currentView.trigger("now",this)},add:function(event){var $form=$(event.target);var view=this.subviews.findByCustom("itemAdd");view.trigger("set:link",$form.find("input").val());this.region.show(view);return false},onRender:function(){this.constructor.__super__.onRender.call(this,arguments);var view=this.subviews.findByCustom(this.model.get("view"));this.region.show(view)}});Application.View.TimelinePublic=Application.View.Timeline.extend({name:"timeline-public",className:"column public",events:{"click .header .now":"now","submit .header .form":"search"},initialize:function(options){this.initSubviews();this.initEvents()},initSubviews:function(){this.subviews=new Backbone.ChildViewContainer;this.initTimeline();this.initFollowings();this.initFollowers()},initTimeline:function(){var collection=new Application.Collection.Items(undefined,{status:this.model.get("status")});var model=new Backbone.Model({pid:this.model.get("pid"),status:this.model.get("status")});
var view=new Application.View.Items({collection:collection,model:model});this.subviews.add(view,"timeline")},initFollowings:function(){var collection=new Application.Collection.Followings;var model=new Backbone.Model({pid:this.model.get("pid"),count:20,start:10});var view=new Application.View.Followings({collection:collection,model:model});this.subviews.add(view,"followings")},initFollowers:function(){var collection=new Application.Collection.Followers;var model=new Backbone.Model({pid:this.model.get("pid"),count:20,start:10});var view=new Application.View.Followers({collection:collection,model:model});this.subviews.add(view,"followers")},initEvents:function(){this.constructor.__super__.initEvents.call(this,arguments);var timeline=this.subviews.findByCustom("timeline"),followings=this.subviews.findByCustom("followings"),followers=this.subviews.findByCustom("followers");this.listenTo(timeline,"item:promoted",function(event){this.trigger("item:promoted",event)});this.on("view:followings",function(){this.region.show(followings)});this.on("view:followers",function(){this.region.show(followers)})},now:function(){this.region.currentView.trigger("refresh",this)},search:function(){return false},onRender:function(){this.constructor.__super__.onRender.call(this,arguments);var self=this;this.region.show=function(view){var $timeline=self.$el.children();var viewClass;if(view.id!==undefined){viewClass=view.id}else{viewClass=view.className.split(" ")[0]}$timeline.attr("class",function(index,className){return className.replace(/\s*view-[^\s]+\s*/g,"")});$timeline.addClass("view-"+viewClass);var $navigation=self.$el.find(".nav > li");$navigation.removeClass("active");$navigation.filter("."+viewClass).addClass("active");return Backbone.Marionette.Region.prototype.show.apply(this,arguments)};var view=this.subviews.findByCustom(this.model.get("view"));this.region.show(view)}});Application.View.Timelines=Backbone.Marionette.ItemView.extend({name:"timelines",template:"#timelines-template",className:"container-wide timelines",initialize:function(options){this.initViews();this.initEvents()},initViews:function(){this.subviews=new Backbone.ChildViewContainer;var publicTimeline=new Application.View.TimelinePublic({model:new Backbone.Model({pid:this.options.public.pid,view:this.options.public.view,status:"p"})});this.subviews.add(publicTimeline,"publicTimeline");var privateTimeline=new Application.View.TimelinePrivate({model:new Backbone.Model({pid:this.options.private.pid,view:this.options.private.view,status:"m"})});this.subviews.add(privateTimeline,"privateTimeline")},initEvents:function(){var publicTimeline=this.subviews.findByCustom("publicTimeline"),privateTimeline=this.subviews.findByCustom("privateTimeline");this.listenTo(publicTimeline,"item:promoted",function(event){privateTimeline.trigger("item:add",event)});this.listenTo(privateTimeline,"item:created",function(event){privateTimeline.trigger("item:add",event)});this.on("public:followings",function(){publicTimeline.trigger("view:followings")});this.on("public:followers",function(){publicTimeline.trigger("view:followers")});this.on("public:timeline",function(){publicTimeline.trigger("view:timeline")});this.on("private:itemAdd",function(){privateTimeline.trigger("view:itemAdd")});this.on("private:timeline",function(){privateTimeline.trigger("view:timeline")})},onRender:function(){var publicTimeline=this.subviews.findByCustom("publicTimeline"),privateTimeline=this.subviews.findByCustom("privateTimeline");this.$el.find(".timeline-public").replaceWith(publicTimeline.render().el);this.$el.find(".timeline-private").replaceWith(privateTimeline.render().el)}});Application.Router.Admin=Backbone.Router.extend({_currentView:null,routes:{login:"login",logout:"logout","profile/new":"newProfile","profile/:pid/edit":"editProfile","profile/:pid":"viewProfile","profile/:pid/following":"following","profile/:pid/followers":"followers","profile/:pid/feeds":"feeds","addfeed/:pid":"addfeed","*default":"home"},initialize:function(){var header=new Application.View.Header({model:new Backbone.Model({pid:Application.session.get("pid")})});Application.header.show(header)},login:function(){var login=new Application.View.Login({model:new Application.Model.Credentials});Application.content.show(login)},home:function(){var self=this;var check=Application.session.check();check.done(function(){var home=new Application.Admin.View.Home({model:new Backbone.Model({pid:Application.session.get("pid"),message:undefined})});Application.content.show(home)});check.fail(function(){Backbone.history.navigate("login",true)})},viewProfile:function(pid){var self=this;var check=Application.session.check();check.done(function(){var profile=new Application.Model.Profile({pid:pid});profile.fetch().done(function(){var items=new ProfileItems({pid:pid});items.fetch().done(function(){if(profile.get("parentpid")){self.changePage(new FeedView({model:profile,items:items}))}else{var view=new Application.Admin.View.ProfileView({model:new Backbone.Model({model:profile,items:items})});Application.content.show(view)}}).fail(function(){var view=new Application.Admin.View.Home({model:new Backbone.Model({message:"Problem retrieving profile items for '"+pid+"'"})});Application.content.show(view)})}).fail(function(){var view=new Application.Admin.View.Home({model:new Backbone.Model({message:"Problem retrieving profile '"+pid+"'"})});Application.content.show(view)})});check.fail(function(){self.invalidSession()})},following:function(pid){var self=this;Application.session.check(function(){var list=new FollowingList({pid:pid});list.fetch({success:function(){self.changePage(new FollowingListView({collection:list}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},followers:function(pid){var self=this;Application.session.check(function(){var list=new FollowersList({pid:pid});list.fetch({success:function(){self.changePage(new FollowersListView({collection:list}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},feeds:function(pid){var self=this;Application.session.check(function(){var list=new Application.Collection.Feeds({pid:pid});list.fetch({success:function(){self.changePage(new FeedsListView({collection:list}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},editProfile:function(pid){var self=this;Application.session.check(function(){var profile=new Profile({pid:pid});profile.fetch({success:function(){if(profile.get("parentpid")){self.changePage(new EditFeedView({model:profile}))}else{self.changePage(new EditProfileView({model:profile}))}},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},newProfile:function(){var self=this;Application.session.check(function(){self.changePage(new AddProfileView({el:$("#content")}))},function(){self.invalidSession()})},addfeed:function(pid){var self=this;Application.session.check(function(){var profile=new Profile({pid:pid});profile.fetch({success:function(){self.changePage(new AddFeedView({model:profile}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},invalidSession:function(){self.changePage(new StaticView({name:"Application.session"}))}});Application.Router.User=Backbone.Router.extend({routes:{login:"login",logout:"logout",register:"register",timeline:"timeline",followings:"followings",followers:"followers","user/:id":"user"},initialize:function(){this.header=new Application.View.Header({model:new Backbone.Model({pid:Application.session.get("pid"),wide:false})});Application.header.show(this.header)},timeline:function(){var self=this;var check=Application.session.check();check.done(function(){self.header.model.set("wide",true);self.header.render();var timeline=new Application.View.Timelines({"public":{pid:Application.session.get("pid"),view:"timeline"},"private":{pid:Application.session.get("pid"),view:"timeline"}});if(Application.content.is("timelines")===true){Application.content.currentView.trigger("public:timeline")}else{Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},followers:function(){var self=this;var check=Application.session.check();check.done(function(){self.header.model.set("wide",true);self.header.render();var timeline=new Application.View.Timelines({"public":{pid:Application.session.get("pid"),view:"followers"},"private":{pid:Application.session.get("pid"),view:"timeline"}});if(Application.content.is("timelines")){Application.content.currentView.trigger("public:followers")}else{Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},followings:function(){var self=this;var check=Application.session.check();check.done(function(){self.header.model.set("wide",true);self.header.render();var timeline=new Application.View.Timelines({"public":{pid:Application.session.get("pid"),view:"followings"},"private":{pid:Application.session.get("pid"),view:"timeline"}});if(Application.content.is("timelines")){Application.content.currentView.trigger("public:followings");Application.content.currentView.trigger("private:followings")}else{Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},login:function(){var login=new Application.View.Login({model:new Application.Model.Credentials});Application.content.show(login)},register:function(){var register=new Application.View.Register({model:new Application.Model.RegistrationInfo});Application.content.show(register)},user:function(pid){var self=this;var check=Application.session.check();check.done(function(){self.header.model.set("wide",true);self.header.render();var timeline=new Application.View.Timelines({"public":{pid:pid,view:"timeline"},"private":{pid:Application.session.get("pid"),view:"timeline"}});Application.content.show(timeline)});check.fail(function(){Backbone.history.navigate("login",true)})},logout:function(){Application.session.destroy();Backbone.history.navigate("login",true)}});
//@ sourceMappingURL=/-assets/javascripts/application/source-map.js