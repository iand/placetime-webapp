var Application=new Backbone.Marionette.Application;Application.Admin={Model:{},View:{},Collection:{},Router:{}};Application.Model={};Application.View={};Application.Collection={};Application.Router={};Application.addRegions({header:".layout-header",content:".layout-content"});Backbone.Marionette.Region.prototype.is=function(view){if(this.currentView===view){return true}else if(this.currentView===undefined){return false}else if(this.currentView.name===view){return true}else{return false}};Application.addInitializer(function(options){Application.session=new Application.Model.Session;var cookie=$.cookie("ptsession");if(cookie){Application.session.set("ptsession",cookie)}});Application.addInitializer(function(options){if(options.router==="admin"){Application.router=new Application.Router.Admin}else{Application.router=new Application.Router.User}Application.router.on("route",function(route){$("body").removeAttr("class").addClass("route-"+route)})});Application.addInitializer(function(){var closeBtn='<a title="Close" class="fancybox-item fancybox-close">';closeBtn+='<i class="icon-remove-circle"></i>';closeBtn+="</a>";$(".fancybox").fancybox({maxWidth:970,maxHeight:800,padding:5,fitToView:false,width:"70%",height:"90%",autoSize:false,closeClick:false,openEffect:"none",closeEffect:"none",arrows:false,tpl:{closeBtn:closeBtn}})});Application.on("initialize:after",function(options){var matched=Backbone.history.start({root:"/"});var session=Application.session.check();session.done(function(){if(Application.session.isNew()==true){Backbone.history.navigate("user/email",true)}else{if(matched===false){Backbone.history.navigate("timeline",true)}}});session.fail(function(){if(["login","register"].indexOf(Backbone.history.fragment)!==-1){return}else{Backbone.history.navigate("login",true)}})});Application.Model.Credentials=Backbone.Model.extend({defaults:{pid:null,pwd:null},url:"/-session",initialize:function(){this.validators={};this.validators.pid=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your username."}};this.validators.pwd=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your password."}}},validateItem:function(key){return this.validators[key]?this.validators[key](this.get(key)):{isValid:true}},validateAll:function(){var messages={};for(var key in this.validators){if(this.validators.hasOwnProperty(key)){var check=this.validators[key](this.get(key));if(check.isValid===false){messages[key]=check.message}}}return _.size(messages)>0?{isValid:false,messages:messages}:{isValid:true}}});Application.Model.Feed=Backbone.Model.extend({});Application.Model.Item=Backbone.Model.extend({now:false,defaults:{via:undefined,image:undefined,media:undefined,duration:{days:undefined,hours:undefined,minutes:undefined,seconds:undefined,original:undefined}},initialize:function(data){if(data&&data.duration){this.set("duration",this.duration(data.duration))}},idSafe:function(){return this.id.replace(/@/,"\\@")},duration:function(secs){var current=moment(),duration=moment();duration.add("seconds",secs);var days=duration.diff(current,"days"),hours=duration.diff(current,"hours"),minutes=duration.diff(current,"minutes"),seconds=duration.diff(current,"seconds");return{days:days,hours:hours-days*24,minutes:minutes-hours*60,seconds:seconds-minutes*60,original:secs}},time:function(){return moment.unix(this.get("ts").toString().substr(0,10))},isNow:function(){return this.now},isPast:function(){return this.time().diff()<0},isToday:function(){return Math.abs(this.time().diff())<moment().add("day",1).diff()},hasEvent:function(){return this.get("event")!==0},isEvent:function(){return this.get("media")==="event"},isVideo:function(){return this.get("media")==="video"},isAudio:function(){return this.get("media")==="audio"},isText:function(){return this.get("media")==="text"},isAdded:function(){return this.get("ts").toString().substr(0,10)===this.get("added").toString()},save:function(){var promise=$.ajax({url:"/-tadd",type:"post",data:{pid:Application.session.get("pid"),link:this.get("link"),text:this.get("text"),image:this.get("image"),media:this.get("media"),ets:this.get("ets"),duration:this.get("duration")}});return promise},detect:function(best){if(best===false){best=0}else{best=1}var promise=$.ajax({url:"/-jdetect",dataType:"json",data:{url:this.get("link"),best:best}});return promise},flag:function(){this.trigger("flagged",this.attributes);var promise=$.ajax({url:"/-tflagprofile",type:"post",data:{pid:this.get("pid")}});return promise},promote:function(){var self=this;var promise=$.ajax({url:"/-tpromote",type:"post",dataType:"json",data:{pid:Application.session.get("pid"),id:this.get("id")}});promise.done(function(data){_.each(data,function(item){item.promoted=true});self.trigger("item:promoted",data)});return promise},demote:function(){var self=this;var promise=$.ajax({url:"/-tdemote",type:"post",data:{pid:Application.session.get("pid"),id:this.get("id")}});promise.done(function(data){_.each(data,function(item){item.demoted=true});self.trigger("item:demoted",self)});return promise}});Application.Model.Profile=Backbone.Model.extend({defaults:{name:undefined,bio:undefined,email:undefined,profileimageurl:undefined},idAttribute:"pid",url:function(){return"/-jpr?pid="+this.get("pid")},save:function(){this.trigger("updated",this.attributes);var promise=$.ajax({url:"/-tupdateprofile",type:"post",data:{pid:Application.session.get("pid"),name:this.get("name"),feedurl:this.get("feedurl"),bio:this.get("bio"),email:this.get("email")}});return promise},destroy:function(){this.trigger("updated",this.attributes);var promise=$.ajax({url:"/-tremprofile",type:"post",data:{pid:Application.session.get("pid")}});return promise},flag:function(){this.trigger("flagged",this.attributes);var promise=$.ajax({url:"/-tflagprofile",type:"post",data:{pid:this.get("pid")}});return promise},follow:function(){this.collection.trigger("profile:follow",this.attributes);this.trigger("followed",this.attributes);var promise=$.ajax({url:"/-tfollow",type:"post",data:{pid:Application.session.get("pid"),followpid:this.get("pid")}});return promise},unfollow:function(){this.collection.trigger("profile:unfollow",this.attributes);this.collection.remove(this);this.trigger("unfollowed",this.attributes);var promise=$.ajax({url:"/-tunfollow",type:"post",data:{pid:Application.session.get("pid"),followpid:this.get("pid")}});return promise}});Application.Model.Register=Backbone.Model.extend({defaults:{pid:null,pwd:null,name:null,email:null},url:"/-taddprofile",initialize:function(){this.validators={};this.validators.pid=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your username."}};this.validators.pwd=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your password."}};this.validators.name=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your full name."}};this.validators.email=function(value){return value!==null&&value.length!==0?{isValid:true}:{isValid:false,message:"Please enter your email address."}}},validateItem:function(key){return this.validators[key]?this.validators[key](this.get(key)):{isValid:true}},validateAll:function(){var messages={};for(var key in this.validators){if(this.validators.hasOwnProperty(key)){var check=this.validators[key](this.get(key));if(check.isValid===false){messages[key]=check.message}}}return _.size(messages)>0?{isValid:false,messages:messages}:{isValid:true}},save:function(){var promise=$.ajax({url:this.url,type:"post",data:{pid:this.get("pid"),pwd:this.get("pwd"),name:this.get("name"),email:this.get("email")}});return promise}});Application.Model.SearchItem=Application.Model.Item.extend({now:false,time:function(){if(this.isEvent()===true){return moment.unix(this.get("event").toString().substr(0,10))}else{return moment.unix(this.get("added").toString().substr(0,10))}},isNow:function(){return this.now},isPast:function(){return this.time().diff()<0},isToday:function(){return Math.abs(this.time().diff())<moment().add("day",1).diff()},isEvent:function(){return this.get("media")==="event"},isVideo:function(){return this.get("media")==="video"},isAudio:function(){return this.get("media")==="audio"},isText:function(){return this.get("media")==="text"},add:function(){var self=this;var promise=$.ajax({url:"/-tadd",type:"post",dataType:"json",data:{pid:Application.session.get("pid"),link:this.get("link"),text:this.get("text"),image:this.get("image"),media:this.get("media"),ets:this.get("ets"),duration:this.get("duration")}});promise.done(function(data){self.trigger("item:added",data[0])});return promise}});Application.Model.SearchProfile=Application.Model.Profile.extend({});Application.Model.Session=Backbone.Model.extend({defaults:{pid:null},events:{change:function(){}},initialize:function(){var cookie=$.cookie("ptsession");if(cookie!==undefined){this.set("pid",cookie.split("|")[0])}},check:function(){var self=this;var promise=$.ajax({url:"/-chksession"});promise.done(function(){var ptsession=$.cookie("ptsession");if(ptsession!==undefined){self.set("pid",ptsession.split("|")[0])}if($.cookie("ptnewuser")===undefined||$.cookie("ptnewuser")==="null"){self.set("id",ptsession.split("|")[0])}});promise.fail(function(){self.set("pid",null)});return promise},save:function(){var self=this;var promise=$.ajax({url:"/-session",type:"post",data:{pid:self.get("pid"),pwd:self.get("pwd")}});promise.done(function(data){self.set("pwd",null);self.set("ptsession",$.cookie("ptsession"))});promise.fail(function(data){self.set("pwd",null)});return promise},destroy:function(){$.cookie("ptsession",null)},location:function(){var promise=$.ajax({url:"/-jgeo",dataType:"json"});return promise}});Handlebars.registerHelper("and",function(testA,testB,options){if(testA&&testB){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("or",function(testA,testB,options){if(testA||testB){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("is",function(value,test,options){if(value===test){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("isnt",function(value,test,options){if(value!==test){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("ifHasEvent",function(value,options){var model=new Application.Model.Item({event:value});if(model.hasEvent()===true){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("urlItem",function(value){return window.location.origin+"/item/"+value});Handlebars.registerHelper("ifSpotify",function(value,options){if(/spotify\./.test(value)===true){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("getSpotifyUrl",function(value){return"https://embed.spotify.com/?uri="+value});Handlebars.registerHelper("fromNow",function(value){return moment.unix(value.toString().substr(0,10)).fromNow()});Handlebars.registerHelper("ifYoutube",function(value,options){if(/youtube\./.test(value)===true){return options.fn(this)}else{return options.inverse(this)}});Handlebars.registerHelper("getYoutubeUrl",function(value){return"http://www.youtube.com/embed/"+value.replace(/https?:\/\/(?:gdata\.|www\.)?youtube.com\/(?:feeds\/api\/videos\/|watch\?v=)/,"")});Application.Collection.Feeds=Backbone.Collection.extend({model:Application.Model.Feed,initialize:function(options){this.pid=options.pid},url:function(){return"/-jfeeds?pid="+this.pid}});Application.Collection.Followers=Backbone.Collection.extend({model:Application.Model.Profile,url:"/-jfollowers"});Application.Collection.Followings=Backbone.Collection.extend({model:Application.Model.Profile,url:"/-jfollowing"});Application.Collection.ItemsProfile=Backbone.Collection.extend({model:Application.Model.Item,initialize:function(options){this.pid=options.pid},url:function(){return"/-jtl?status=m&before=100&after=100&pid="+this.pid}});Application.Collection.Items=Backbone.Collection.extend({model:Application.Model.Item,url:"/-jtl",initialize:function(collection,options){this.options=options;this.on("item:demoted",function(target){var models=this.filter(function(item){return item.get("id")===target.get("id")});this.remove(models)})},fetch:function(options){options.data=_.extend(this.options,options.data);return Backbone.Collection.prototype.fetch.call(this,options)},now:function(){var self=this;var options={data:{pid:this.options.pid,status:this.options.status},remove:false};var defer=$.Deferred();Backbone.Collection.prototype.fetch.call(this,options).done(function(data){if(data.length===0){defer.reject()}else{self.each(function(model){model.now=false});var model=self.get(data[0].id);model.now=true;defer.resolve(model)}}).fail(function(){defer.reject()});return defer.promise()},comparator:function(model){return-model.get("ts")}});Application.Collection.Searches=Backbone.Collection.extend({url:"/-jsearch",initialize:function(collection,options){this.options=options||{};this.on("item:demoted",function(target){var models=this.filter(function(item){return item.get("id")===target.get("id")});this.remove(models)})},search:function(options){var self=this;var promise=$.ajax({url:this.url,type:"get",dataType:"json",data:options.data});if(options.data.t==="p"){this.model=Application.Model.SearchProfile}else{this.model=Application.Model.SearchItem}promise.done(function(data){self.set(data.results)});promise.fail(function(){});return promise},comparator:function(model){return-model.get("ts")}});Application.Collection.Suggestions=Backbone.Collection.extend({model:Application.Model.Profile,url:"/-jsp"});Application.View.Timeline=Backbone.Marionette.ItemView.extend({name:"timeline",template:{type:"handlebars",template:JST["timeline"]},className:"layout-column",refreshLastUpdate:moment().subtract("seconds",2),infiniteScrollReference:null,infiniteScrollScrollTop:0,infiniteScrollLastUpdate:moment().subtract("seconds",2),initialEvents:function(){$(window).on("resize",_.bind(this.resize,this));this.on("all",function(event){var match=event.match(/view:(.*)/);if(match===null){return}this.model.set("view",match[1])});this.on("item:add",function(event){this.regionManager.get("collection").currentView.trigger("item:add",event)});this.on("scrollTo:before",function(event){this.regionManager.get("collection").currentView.trigger("scrollTo:before",event)});this.on("scrollTo:after",function(event){this.regionManager.get("collection").currentView.trigger("scrollTo:after",event)});this.on("view:timeline",function(options){this.timeline(options)});this.on("scrollTo",this.scrollTo);this.on("scrollTo:before",this.scrollToBefore);this.on("scrollTo:after",this.scrollToAfter);this.on("scroll",this.infiniteScroll)},bindEvents:function(view){var self=this;if(view.collection){this.listenToOnce(view.collection,"sync",function(event){this.now()})}this.listenTo(view,"show",this.resize);this.listenTo(view,"render",this.resize);this.listenTo(view,"scroll",this.infiniteScroll);this.listenTo(view,"scrollTo",this.scrollTo)},resize:function(){this.$el.find(".scroller").height($(window).height()-60)},reload:function(){this.regionManager.get("collection").currentView.trigger("reload",this)},now:function(){this.regionManager.get("collection").currentView.trigger("now",this)},refresh:function(){if(moment().diff(this.refreshLastUpdate)<1e3){return}this.refreshLastUpdate=moment();this.listenToOnce(this.regionManager.get("collection").currentView,"reload:done",function(){this.now()});this.listenToOnce(this.regionManager.get("collection").currentView,"now:done",function(){this.refreshLastUpdate=moment()});this.reload()},onRender:function(){this.regionManager=new Marionette.RegionManager;this.regionManager.addRegions({header:{parentEl:this.$el,selector:".timeline-header"},collection:{parentEl:this.$el,selector:".timeline-collection"}});this.trigger("view:"+this.model.get("view"),this.model.get("options"))},scrollTo:function(event){var self=this;var $scroller=this.$el.find(".scroller");if(event.top===$scroller.scrollTop()){return}self.trigger("scrollTo:before");$scroller.animate({scrollTop:event.top,scrollLeft:event.left},event.duration,function(){self.trigger("scrollTo:after")})},scrollToBefore:function(){this.scrollToScrolling=true},scrollToAfter:function(event){var deferred=_.bind(function(){this.scrollToScrolling=false},this,event);clearTimeout(this.scrollToReference);this.scrollToReference=setTimeout(deferred,150)},infiniteScroll:function(event){var deferred=_.bind(this.infiniteScrollDeferred,this,event);clearTimeout(this.infiniteScrollReference);if(this.scrollToScrolling===true){return}else{this.infiniteScrollReference=setTimeout(deferred,150)}},infiniteScrollDeferred:function(event){var $target=$(event.target);var threshold=140*20;var scrollTop=$target.scrollTop(),maxScrollTop=$target.find(".collection-children").height();if(this.infiniteScrollLoading===true){return}else if(moment().diff(this.infiniteScrollLastUpdate)<2e3){return}else if(Math.abs(scrollTop)<threshold){this.infiniteScrollScrollTop=scrollTop;this.infiniteScrollLastUpdate=moment();var collection=this.regionManager.get("collection").currentView;collection.trigger("infinite:load",{after:true});this.listenToOnce(collection,"infinite:done",function(data){this.$el.find(".scroller").scrollTop(this.infiniteScrollScrollTop)})}else if(Math.abs(scrollTop)>Math.abs(maxScrollTop-threshold)){this.infiniteScrollLastUpdate=moment();this.regionManager.get("collection").currentView.trigger("infinite:load",{before:true})}else{return}}});Application.View.TimelineItem=Backbone.Marionette.ItemView.extend({events:{"click .flag":"flag","click .button-add":"add","click .button-promote":"promote","click .button-demote":"demote","click .audio":"load"},modelEvents:{flagged:"onFlagged","item:promoted":"onPromoted","item:demoted":"onDemoted"},attributes:function(){var attributes={"data-id":this.model.id};if(this.model.get("image")){if(/^https?/.test(this.model.get("image"))===true){attributes.style="background-image: url("+this.model.get("image")+")"}else{attributes.style="background-image: url(/-img/"+this.model.get("image")+")"}}return attributes},load:function(){this.$el.off("click.delegateEvents"+this.cid,".audio");var $text=this.$el.find(".item-text"),$time=this.$el.find(".time"),$duration=this.$el.find(".duration");var $iframe=$("<iframe />");$iframe.addClass("item-listen collapsed");$iframe.attr({src:Application.Helpers.getSpotifyUrl(this.model.get("link")),height:80,frameborder:0,allowtransparency:true,width:680});if(this.model.get("status")==="m"){$iframe.attr("width",420)}else{$iframe.attr("width",680)}$iframe.insertAfter($text);$text.addClass("collapsed");$duration.addClass("collapsed");$iframe.removeClass("collapsed");return false},remove:function(){var self=this,args=arguments;this.$el.transitionEnd(function(event){if(event.propertyName!=="max-height"){return}Backbone.Marionette.ItemView.prototype.remove.apply(self,args)});this.$el.addClass("collapsed")},flag:function(event){this.model.flag();return false},add:function(){this.model.add();return false},promote:function(){this.model.promote();return false},demote:function(){this.model.demote();return false},onFlagged:function(){this.$el.addClass("flagged")},onPromoted:function(){this.$el.removeClass("now").addClass("promoted")},onDemoted:function(){},onRender:function(){this.$el.data("model",this.model)}});Application.View.TimelineProfile=Backbone.Marionette.ItemView.extend({className:"item item-profile",events:{"click .flag":"flag","click .button-unfollow":"unfollow","click .button-follow":"follow"},modelEvents:{flagged:"onFlagged",followed:"onFollowed",unfollowed:"onUnfollowed"},attributes:function(){return{"data-pid":this.model.get("pid")}},flag:function(event){this.model.flag();return false},follow:function(event){this.model.follow();return false},unfollow:function(event){this.model.unfollow();return false},remove:function(){var self=this,args=arguments;this.$el.transitionEnd(function(event){if(event.propertyName!=="max-height"){return}Backbone.Marionette.ItemView.prototype.remove.apply(self,args)});this.$el.addClass("collapsed")},onShow:function(){this.$el.offset();this.$el.removeClass("collapsed")},onRender:function(){this.$el.data("model",this.model)},onFlagged:function(){this.$el.addClass("flagged")},onFollowed:function(){this.$el.addClass("followed")},onUnfollowed:function(){}});Application.View.User=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["user"]},className:"user layout-container",events:{"submit form":"submit","click .destroy":"destroy","click .service":"optOut","click .cancel":"cancel"},modelEvents:{change:"render"},optOut:function(event){var $target=$(event.target);var checked=$target.prop("checked");if(checked===true){}else{}},submit:function(event){var data=$(event.target).serializeObject();var promise=this.model.set(data).save();promise.done(function(){Backbone.history.navigate("timeline",true)});promise.fail(function(){});return false},destroy:function(){if(confirm("Are you sure you want to delete your profile?")===false){return}promise=this.model.destroy();promise.done(function(){Backbone.history.navigate("login",true)});promise.fail(function(){});return false},cancel:function(){Backbone.history.navigate("timeline",true);return false},onShow:function(){this.model.fetch()}});Application.Admin.View.Back=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["back"]},className:"back"});Application.Admin.View.FeedBrief=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["feed-brief"]}});Application.Admin.View.FeedEdit=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["feed-edit"]},events:{"click .saveBtn":"save"},save:function(){var self=this;$.ajax({url:"/-tupdateprofile",type:"post",data:{pid:this.model.get("pid"),name:$("#name").val(),parentpid:$("#parentpid").val(),feedurl:$("#feedurl").val()},success:function(data){Backbone.history.navigate("profile/"+self.model.get("pid"),true)}});return false}});Application.Admin.View.FeedList=Backbone.Marionette.CompositeView.extend({template:{type:"handlebars",template:JST["feeds"]},itemView:Application.Admin.View.FeedBrief});Application.Admin.FeedNew=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["feed-new"]},events:{"click .saveBtn":"save"},save:function(event){var self=this;var data=$(event.target).serializeObject();var promise=$.ajax({url:"/-taddprofile",type:"post",data:{pid:this.model.get("pid")+"~"+$("#feedpid").val(),name:$("#name").val(),parentpid:this.model.get("pid"),feedurl:$("#feedurl").val()}});promise.done(function(){Backbone.history.navigate("profile/"+self.model.get("pid"),true)});promise.fail(function(){});return false}});Application.Admin.FeedView=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["feed-view"]},events:{"click .editBtn":"edit","click .refreshBtn":"refresh","click .deleteBtn":"delete"},initialize:function(options){this.initItemViews(options.items)},edit:function(){Backbone.history.navigate("editprofile/"+this.model.get("pid"),true);return false},refresh:function(){var self=this;$.ajax({url:"/-refresh",type:"get",data:{pid:self.model.get("pid")},success:function(data){var items=new ProfileItems({pid:self.model.get("pid")});items.fetch({success:function(){self.initItemViews(items);self.msg="";self.render()},error:function(request,status,error){self.msg="There was a problem displaying feed items: "+request.responseText;self.render()}})},error:function(request,status,error){self.msg="There was a problem refreshing feed items: "+request.responseText;self.render()}});return false},"delete":function(){var self=this;$.ajax({url:"/-tremprofile",type:"post",data:{pid:self.model.get("pid")},success:function(){Backbone.history.navigate("profile/"+self.model.get("parentpid"),true)},error:function(request,status,error){self.msg="There was a problem deleting the feed: "+request.responseText;self.render()}});return false},initItemViews:function(items){this._views=[];var self=this;items.each(function(m){self._views.push(new BriefItemView({model:m}))})},render:function(){$(".msg",this.el).html(this.msg);var self=this;_(this._views).each(function(v){$(".items",self.el).append(v.render().el)});return this}});Application.Admin.View.Followers=Backbone.Marionette.CollectionView.extend({template:{type:"handlebars",template:JST["followers"]},itemView:Application.Admin.View.FollowerBrief});Application.Admin.View.Followings=Backbone.Marionette.CollectionView.extend({template:{type:"handlebars",template:JST["followings"]},itemView:Application.View.ProfileBrief});Application.Admin.View.Home=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["home"]},className:"layout-container",events:{"submit form":"profile"},profile:function(){var url="profile/"+this.$el.find("input[name=pid]").val();Backbone.history.navigate(url,true);return false}});Application.Admin.View.ItemBrief=Backbone.Marionette.ItemView.extend({tagName:"li",className:"profile-item-brief",template:{type:"handlebars",template:JST["item-brief"]}});Application.Admin.View.ItemListBrief=Backbone.Marionette.CollectionView.extend({tagName:"ul",className:"profile-items-brief",itemView:Application.Admin.View.ItemBrief,initialize:function(){this.collection.fetch()}});Application.Admin.View.ProfileBrief=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["profile-brief"]}});Application.Admin.View.ProfileEdit=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["profile-edit"]},className:"layout-container",events:{"submit form":"submit"},onShow:function(){var view=new Application.Admin.View.Back;view.render();this.$el.prepend(view.el)},submit:function(event){var self=this;var data=$(event.target).serializeObject();var promise=$.ajax({url:"/-tupdateprofile",type:"post",data:data});promise.done(function(){Backbone.history.navigate("profile/"+self.model.get("pid"),true)});promise.fail(function(){});return false}});Application.Admin.View.ProfileNew=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["profile-new"]},className:"layout-container",events:{"submit form":"submit"},submit:function(event){var data=$(event.target).serializeObject();var promise=$.ajax({url:"/-taddprofile",type:"post",data:data});promise.done(function(){Backbone.history.navigate("profile/"+data.pid,true)});promise.fail(function(){});return false}});Application.Admin.View.ProfileView=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["profile-view"]},className:"layout-container",events:{"click .profile-edit":"edit","click .profile-add":"add"},edit:function(){Backbone.history.navigate("profile/"+this.model.get("pid")+"/feed/edit/",true);return false},add:function(){Backbone.history.navigate("profile/"+this.model.get("pid")+"/feed/new",true);return false},onShow:function(){var view=new Application.Admin.View.Back;view.render();this.$el.prepend(view.el)},onRender:function(){var view=new Application.Admin.View.ItemListBrief({collection:new Application.Collection.ItemsProfile({pid:this.model.get("pid")})});this.$el.find(".profile-items").append(view.el)}});var StaticView=Backbone.View.extend({initialize:function(options){this.template=_.template($("#"+options.name+"-tmpl").html())},render:function(){$(this.el).html(this.template());return this}});Application.View.Follower=Application.View.TimelineProfile.extend({template:{type:"handlebars",template:JST["follower"]}});Application.View.Followers=Backbone.Marionette.CompositeView.extend({template:{type:"handlebars",template:JST["followers"]},className:"collection collection-followers",itemView:Application.View.Follower,itemViewContainer:".collection-children",modelEvents:{"change:loading":"render"},initialize:function(options){this.on("infinite:load",this.load);this.on("infinite:load",this.loading);this.on("infinite:done",this.loaded);this.on("infinite:failed",this.loaded)},onShow:function(){var self=this;var promise=this.collection.fetch({data:{pid:this.model.get("pid"),count:this.model.get("count")},remove:true});promise.always(function(){self.model.set("loading",false)})},onFollowed:function(){this.$el.addClass("followed")},onUnfollowed:function(){},load:function(options){if(options.before){return}var self=this;var data={pid:self.model.get("pid"),start:self.model.get("start"),count:10};self.collection.fetch({remove:false,data:data}).done(function(data){if(data.length>0){self.model.set("start",data.start+10)}self.trigger("infinite:done",data)}).fail(function(){self.trigger("infinite:failed")})},loading:function(options){this.loading=new Application.View.Loading(options);this.loading.render();this.$el.append(this.loading.$el)},loaded:function(options){this.loading.remove()},showEmptyView:function(){var EmptyView=Marionette.getOption(this,"emptyView");if(EmptyView&&!this._showingEmptyView){this._showingEmptyView=true;this.addItemView(this.model,EmptyView,0)}},buildItemView:function(item,ItemViewType,itemViewOptions){var view=Backbone.Marionette.CompositeView.prototype.buildItemView.apply(this,arguments);view.model.set({user:this.model.get("pid"),session:Application.session.get("pid")},{silent:true});return view}});Application.View.Following=Application.View.TimelineProfile.extend({template:{type:"handlebars",template:JST["following"]}});Application.View.Followings=Backbone.Marionette.CompositeView.extend({template:{type:"handlebars",template:JST["followings"]},className:"collection collection-followings",itemView:Application.View.Following,itemViewContainer:".collection-children",modelEvents:{"change:loading":"render"},initialize:function(options){this.on("infinite:load",this.load);this.on("infinite:load",this.loading);this.on("infinite:done",this.loaded);this.on("infinite:failed",this.loaded)},onShow:function(){var self=this;var promise=this.collection.fetch({data:{pid:this.model.get("pid"),count:this.model.get("count")},remove:true});promise.always(function(){self.model.set("loading",false)})},load:function(options){if(options.before){return}var self=this;var data={pid:self.model.get("pid"),start:self.model.get("start"),count:10};self.collection.fetch({remove:false,data:data}).done(function(data){if(data.length>0){self.model.set("start",data.start+10)}self.trigger("infinite:done",data)}).fail(function(){self.trigger("infinite:failed")})},loading:function(options){this.loading=new Application.View.Loading(options);this.loading.render();this.$el.append(this.loading.$el)},loaded:function(options){this.loading.remove()},showEmptyView:function(){var EmptyView=Marionette.getOption(this,"emptyView");if(EmptyView&&!this._showingEmptyView){this._showingEmptyView=true;this.addItemView(this.model,EmptyView,0)}},buildItemView:function(item,ItemViewType,itemViewOptions){var view=Backbone.Marionette.CompositeView.prototype.buildItemView.apply(this,arguments);view.model.set({user:this.model.get("pid"),session:Application.session.get("pid")},{silent:true});return view}});Application.View.Header=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["header"]},className:"navbar",events:{"click .navbar-brand":"reload"},modelEvents:{"change:pid":"render"},reload:function(){window.location.href=window.location.href.replace(window.location.hash,"");return false}});Application.View.ItemAdd=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["item-add"]},className:"item item-add",events:{"submit .item-add-form":"submit","click .item-add-event input":"event","click .item-add-type input":"toggle","click .item-add-btn-cancel":"cancel","click .item-add-image-controls-next":"next","click .item-add-image-controls-prev":"prev"},modelEvents:{change:"render"},ui:{form:".item-add-form",title:".item-add-title",type:".item-add-type",event:".item-add-event",ets:".item-add-ets",duration:".item-add-duration",error:".form-error",list:".item-add-image-list",controls:".item-add-controls"},initialize:function(options){var self=this;
this.model.set({loading:true,text:"",ets:""});var promise=this.model.detect();promise.done(function(data){if(data.images.length===0){return}data.images.unshift("/-img/"+data.bestImage);self.model.set("images",data.images);self.model.set("image",data.images[0])});promise.always(function(){self.model.set("loading",false)})},event:function(){this.ui.ets.toggle();this.ui.ets.find("input").val(null)},toggle:function(event){var value=$(event.target).val();if(value==="text"){this.ui.duration.hide()}else{this.ui.duration.show()}if(value==="event"){this.ui.ets.show()}else{this.ui.ets.hide()}},submit:function(event){var data=this.ui.form.serializeObject();var self=this;var promise=this.model.set(data).save();promise.done(function(){self.trigger("created")});promise.fail(function(){});return false},cancel:function(){this.trigger("cancelled");return false},next:function(){var $current=this.ui.list.find(".item-add-image-list-current");var $next=$current.next();if($next.length===0){$next=this.ui.list.find(".item-add-image-list-item").first()}$next.addClass("item-add-image-list-current");$current.removeClass("item-add-image-list-current");this.model.set("image",$next.css("background-image"),{silent:true});return false},prev:function(){var $current=this.ui.list.find(".item-add-image-list-current");var $prev=$current.prev();if($prev.length===0){$prev=this.ui.list.find(".item-add-image-list-item").last()}$prev.addClass("item-add-image-list-current");$current.removeClass("item-add-image-list-current");this.model.set("image",$prev.css("background-image"),{silent:true});return false},onShow:function(){if(Modernizr.inputtypes.date===false){$("input[type=date]").datepicker({changeMonth:true,changeYear:true,dateFormat:"mm/dd/yy"})}this.ui.title.find("input").focus();this.$el.find("select, input[type=radio], input[type=checkbox]").uniform({useID:false})},onClose:function(){$("input[type=date]").datepicker("destroy");$.uniform.restore("select");$.uniform.restore("input[type=radio]");$.uniform.restore("input[type=checkbox]")}});Application.View.ItemEmpty=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["item-empty"]},className:"item item-empty collapsed",onShow:function(){this.$el.offset();this.$el.removeClass("collapsed")},remove:function(){var self=this,args=arguments;this.$el.transitionEnd(function(event){if(event.propertyName!=="max-height"){return}Backbone.Marionette.ItemView.prototype.remove.apply(self,args)});this.$el.addClass("collapsed")}});Application.View.Item=Application.View.TimelineItem.extend({template:{type:"handlebars",template:JST["item"]},className:function(){var className="item";if(this.model.get("image")){className+=" image"}if(this.model.isEvent()){className+=" event"}else if(this.model.isVideo()){className+=" video"}else if(this.model.isAudio()){className+=" audio"}else if(this.model.isText()){className+=" text"}if(this.model.isPast()){className+=" past"}if(this.model.get("promoted")===true){className+=" collapsed"}return className},onShow:function(){if(this.model.get("promoted")===true){this.$el.offset();this.$el.removeClass("collapsed")}}});Application.View.Items=Backbone.Marionette.CompositeView.extend({template:{type:"handlebars",template:JST["items"]},className:"collection collection-items",events:{"click .needle .icon-repeat":"now"},modelEvents:{"change:loading":"render"},itemViewContainer:".collection-children",itemView:Application.View.Item,emptyView:Application.View.ItemEmpty,collectionEvents:{"item:promoted":"itemPromoted","item:demoted":"itemDemoted","item:added":"itemAdded"},itemDemoted:function(item){this.trigger("item:demoted",item)},itemPromoted:function(item){this.trigger("item:promoted",item)},itemAdded:function(item){this.trigger("item:added",item)},initialize:function(options){var needle=new Application.View.Needle;var now=new Application.View.Now({model:this.model});this.subviews=new Backbone.ChildViewContainer;this.subviews.add(needle,"needle");this.subviews.add(now,"separator");this.on("composite:rendered",function(){this.$el.find(".scroller").scroll(_.bind(this.onScroll,this))});this.on("item:add",function(event){this.once("after:item:added",this.now);this.once("separator:rendered",function(){var item=this.collection.findWhere({id:event.id});var itemPosition=this.$el.find(".item[data-id="+item.idSafe()+"]").position();if(itemPosition.top===46){itemPosition.top=0}this.trigger("scrollTo",{left:itemPosition.left,top:itemPosition.top,duration:jQuery.fx.speeds.slow})});this.collection.add(event)});this.on("infinite:load",this.load);this.on("infinite:load",this.loading);this.on("infinite:done",this.loaded);this.on("infinite:failed",this.loaded);this.on("after:item:added",this.renderNeedle);this.on("item:removed",this.renderNeedle);this.on("after:item:added",this.renderSeparator);this.on("item:removed",this.renderSeparator);this.on("reload",this.reload);this.on("now",this.now);this.on("now:done",this.renderSeparator)},onScroll:function(event){this.trigger("scroll",event);this.subviews.findByCustom("needle").trigger("scroll",event)},onShow:function(){var self=this;var promise=this.collection.fetch({data:{pid:this.model.get("pid"),status:this.model.get("status"),before:25,after:25}});promise.always(function(){self.model.set("loading",false)})},renderNeedle:function(){var $view=this.$el.find(".needle-view");if(this.collection.length>=2){if($view.is(":empty")===true){this.$el.find(".needle-view").html(this.subviews.findByCustom("needle").render().el)}else{this.subviews.findByCustom("needle").trigger("update")}}else{$view.empty()}},reload:function(){var self=this;var promise=this.collection.fetch({data:{pid:this.model.get("pid"),before:25,after:25,ts:undefined},reset:true});promise.done(function(data){self.trigger("reload:done")});promise.fail(function(){self.trigger("reload:error")})},now:function(duration){var self=this;var promise=this.collection.now();promise.done(function(model){var $closest=self.$el.find(".item[data-id="+model.idSafe()+"]"),$needle=self.$el.find(".needle");if($closest.length===0||$needle.length===0){return}var itemPosition=$closest.position(),needlePosition=$needle.position(),separatorHeight=28;if(itemPosition.top===46){itemPosition.top=0}self.trigger("scrollTo",{left:itemPosition.left,top:itemPosition.top-needlePosition.top+separatorHeight,duration:jQuery.fx.speeds.slow});$closest.siblings().removeClass("now");$closest.addClass("now")});promise.done(function(data){self.trigger("now:load")});promise.fail(function(){self.trigger("now:error")});this.once("scrollTo:after",function(){self.trigger("now:done")});return promise},renderSeparator:function(){var separator=this.subviews.findByCustom("separator");separator.remove();if(this.collection.length>0){separator.render();separator.$el.insertBefore(this.$el.find(".item.now"));separator.triggerMethod("show")}},load:function(options){var self=this;var data={pid:self.model.get("pid"),status:self.model.get("status")};if(options.before){data.after=0;data.before=40;data.ts=self.collection.last().get("ts")}else if(options.after){data.after=40;data.before=0;data.ts=self.collection.first().get("ts")}else{throw new Error("Invalid options provided")}self.collection.fetch({remove:false,data:data}).done(function(data){self.trigger("infinite:done",data)}).fail(function(){self.trigger("infinite:failed")})},loading:function(options){this.loading=new Application.View.Loading(options);this.loading.render();this.$el.append(this.loading.$el)},loaded:function(options){this.loading.remove()},showEmptyView:function(){var EmptyView=Marionette.getOption(this,"emptyView");if(EmptyView&&!this._showingEmptyView){this._showingEmptyView=true;this.addItemView(this.model,EmptyView,0)}},appendHtml:function(collectionView,itemView,index){var itemViewContainer=this.getItemViewContainer(collectionView);if(itemViewContainer.children().size()<=index){itemViewContainer.append(itemView.el)}else{itemViewContainer.children().eq(index).before(itemView.el)}},buildItemView:function(item,ItemViewType,itemViewOptions){var view=Backbone.Marionette.CompositeView.prototype.buildItemView.apply(this,arguments);view.model.set({status:this.model.get("status"),user:this.model.get("pid"),session:Application.session.get("pid")},{silent:true});return view}});Application.View.Loading=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["loading"]},className:function(options){var className="loading";if(this.options.before){className+=" loading-before"}else if(this.options.after){className+=" loading-after"}else{throw new Error("Invalid options provided")}return className}});Application.View.Login=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["login"]},className:"login container",events:{"click .login-login":"login","submit .login-form":"submit"},ui:{form:".login-form",error:".form-error"},login:function(){this.ui.form.show();return},submit:function(event){var data=this.ui.form.serializeObject();var self=this,promise=Application.session.set(data).save();self.ui.error.empty();promise.done(function(){Backbone.history.navigate("timeline",true)});promise.fail(function(xhr,status,error){if(status==="error"){error=error.toLowerCase();switch(error){case"unauthorized":self.ui.error.text("The credentials provided are invalid");break}}else if(status==="timeout"){self.ui.error.text("The server is experiencing heavy load")}});return false}});Application.View.Needle=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["needle-now"]},templateCurrent:"needle-now",className:"needle",initialize:function(options){this.on("scroll",this.rotate);this.on("scroll",this.update);this.on("update",this.update)},update:function(){var offset=this.$el.offset();var $item=$(document.elementFromPoint(offset.left,offset.top+6)).closest(".item");if($item.length===0){return}var model=$item.data("model");if(model===undefined){return}var time=$item.data("model").time();if(model.isNow()===true){this.now()}else if(model.isToday()===true){this.updateText(time," hh:mm:ss A","Today at ")}else if(model.isEvent()===true){this.updateText(time,"Do MMMM YYYY")}else{this.updateText(time,"Do MMMM YYYY hh:mm:ss A")}},rotate:function(event){var scrollTop=$(event.target).scrollTop();this.$el.find(".needle-icon-repeat").css({"-webkit-transform":"rotate(-"+scrollTop+"deg)","-moz-transform":"rotate(-"+scrollTop+"deg)","-o-transform":"rotate(-"+scrollTop+"deg)","-ms-transform":"rotate(-"+scrollTop+"deg)",transform:"rotate(-"+scrollTop+"deg)"})},updateText:function(time,format,prefix,suffix){prefix=prefix||"";suffix=suffix||"";if(this.templateCurrent!=="needle"){this.templateCurrent="needle";this.template.template=JST["needle"];this.render()}var $value=this.$el.find(".needle-value");if($value.text()!==prefix+time.format(format)+suffix){$value.text(prefix+time.format(format)+suffix)}},now:function(){this.templateCurrent="needle-now";this.template.template=JST["needle-now"];this.render()},onShow:function(){this.update()}});Application.View.NoResults=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["no-results"]},className:"no-results"});Application.View.Now=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["now"]},className:"now-separator is-collapsed",onRender:function(){this.$el.addClass("is-collapsed")},onShow:function(){this.$el.removeClass("is-collapsed")}});Application.View.Register=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["register"]},className:"register container",events:{"submit .register-form":"submit"},ui:{form:".register-form",error:".form-error"},submit:function(){var data=this.ui.form.serializeObject();var self=this,promise=this.model.set(data).save();promise.done(function(){Backbone.history.navigate("timeline",true)});promise.fail(function(){if(status==="error"){self.ui.error.text("The pid is already taken")}else if(status==="timeout"){self.ui.error.text("The server is experiencing heavy load")}});return false}});Application.View.SearchEmpty=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["search-empty"]},className:"item item-empty collapsed",modelEvents:{"change:loading":"render"},onShow:function(){this.$el.offset();this.$el.removeClass("collapsed")},remove:function(){var self=this,args=arguments;this.$el.transitionEnd(function(event){if(event.propertyName!=="max-height"){return}Backbone.Marionette.ItemView.prototype.remove.apply(self,args)});this.$el.addClass("collapsed")}});Application.View.SearchItem=Application.View.TimelineItem.extend({template:{type:"handlebars",template:JST["search-item"]},className:function(){var className="item";if(this.model.get("image")){className+=" image"}if(this.model.isEvent()){className+=" event"}else if(this.model.isVideo()){className+=" video"}else if(this.model.isAudio()){className+=" audio"}else if(this.model.isText()){className+=" text"}if(this.model.isPast()){className+=" past"}return className}});Application.View.SearchProfile=Application.View.TimelineProfile.extend({template:{type:"handlebars",template:JST["search-profile"]}});Application.View.Searches=Backbone.Marionette.CompositeView.extend({template:{type:"handlebars",template:JST["searches"]},events:{"click .promote":"promote"},modelEvents:{"change:loading":"render"},itemViewContainer:".collection-children",itemView:Application.View.SearchItem,emptyView:Application.View.SearchEmpty,className:function(){var className="collection collection-searches";if(this.model.get("t")==="p"){className+=" profiles"}else{className+=" items"}return className},collectionEvents:{"item:added":"itemAdded"},itemAdded:function(item){this.trigger("item:added",item)},initialize:function(options){this.on("composite:rendered",function(){this.$el.find(".scroller").scroll(_.bind(this.onScroll,this))});this.on("reload",this.reload);this.on("now",this.now)},onScroll:function(event){this.trigger("scroll",event)},onShow:function(){if(this.model.get("t")==="p"){this.itemView=Application.View.SearchProfile}else{this.itemView=Application.View.SearchItem}var self=this;var promise=this.collection.search({data:{t:this.model.get("t"),s:this.model.get("s")}});promise.always(function(){self.model.set("loading",false)})},promote:function(event){var $item=$(event.currentTarget).closest("[data-id]");var model=this.collection.get($item.data("id"));model.promote();return false},showEmptyView:function(){var EmptyView=Marionette.getOption(this,"emptyView");if(EmptyView&&!this._showingEmptyView){this._showingEmptyView=true;this.addItemView(this.model,EmptyView,0)}},appendHtml:function(collectionView,itemView,index){var itemViewContainer=this.getItemViewContainer(collectionView);if(itemViewContainer.children().size()<=index){itemViewContainer.append(itemView.el)}else{itemViewContainer.children().eq(index).before(itemView.el)}},buildItemView:function(item,ItemViewType,itemViewOptions){var view=Backbone.Marionette.CompositeView.prototype.buildItemView.apply(this,arguments);view.model.set({user:this.model.get("pid")},{silent:true});return view}});Application.View.SuggestionEmpty=Backbone.Marionette.ItemView.extend({template:{type:"handlebars",template:JST["suggestion-empty"]},className:"item item-empty collapsed",modelEvents:{"change:loading":"render"},onShow:function(){this.$el.offset();this.$el.removeClass("collapsed")},remove:function(){var self=this,args=arguments;this.$el.transitionEnd(function(event){if(event.propertyName!=="max-height"){return}Backbone.Marionette.ItemView.prototype.remove.apply(self,args)});this.$el.addClass("collapsed")}});Application.View.Suggestion=Application.View.TimelineProfile.extend({template:{type:"handlebars",template:JST["suggestion"]}});Application.View.Suggestions=Backbone.Marionette.CompositeView.extend({template:{type:"handlebars",template:JST["suggestions"]},className:"layout-container",itemViewContainer:".collection-children",itemView:Application.View.Suggestion,emptyView:Application.View.SuggestionEmpty,ui:{form:".suggestions-form",location:".suggestions-location"},events:{"click .update":"update"},modelEvents:{"change:location":"load"},initialize:function(){$(window).on("resize",_.bind(this.resize,this));var self=this;var location=Application.session.location();location.done(function(data){var location=data.countryname+" ";location+=data.region+" ";location+=data.city;location=location.replace(/^\s+|\s+$/g,"");if(location!==""){self.model.set({location:location})}})},resize:function(){this.$el.find(".scroller").height($(window).height())},update:function(){this.model.set("location",this.ui.location.val());return false},load:function(){console.log("load");var self=this;var promise=this.collection.fetch({data:{loc:self.model.get("location")}});promise.always(function(){self.model.set("loading",false)})},showEmptyView:function(){var EmptyView=Marionette.getOption(this,"emptyView");if(EmptyView&&!this._showingEmptyView){this._showingEmptyView=true;this.addItemView(this.model,EmptyView,0)}}});Application.View.TimelineHeader=Backbone.Marionette.ItemView.extend({name:"timeline-header"});Application.View.PrivateTimelineHeader=Application.View.TimelineHeader.extend({template:{type:"handlebars",template:JST["timeline-private-header"]},className:"timeline-header-private",events:{"click .playlist":"playlist","click .now":"refresh","submit .form":"submit"},modelEvents:{change:"render"},playlist:function(){this.trigger("view:playlist");return false},refresh:function(){this.trigger("refresh");return false},submit:function(event){this.trigger("view:itemAdd",$(event.target).serializeObject());return false}});Application.View.TimelinePrivate=Application.View.Timeline.extend({name:"timeline-private",className:"layout-column private",initialize:function(options){this.initialEvents();this.on("view:itemAdd",function(options){this.itemAdd(options)})},timeline:function(options){var collection=new Application.Collection.Items(undefined,{status:this.model.get("status")});var model=new Backbone.Model({loading:true,pid:this.model.get("pid"),status:this.model.get("status")});var view=new Application.View.Items({collection:collection,model:model});this.bindEvents(view);this.listenTo(view,"item:demoted",function(event){this.trigger("item:demoted",event)});this.regionManager.get("collection").show(view)},itemAdd:function(options){var model=new Application.Model.Item;model.set(options);var view=new Application.View.ItemAdd({model:model});this.bindEvents(view);this.listenTo(view,"created",function(){this.timeline()});this.listenTo(view,"cancelled",function(){this.timeline()});this.regionManager.get("collection").show(view)},onRender:function(){this.constructor.__super__.onRender.call(this,arguments);var header=new Application.View.PrivateTimelineHeader({model:this.model});this.listenTo(header,"refresh",this.refresh);this.listenTo(header,"view:itemAdd",this.itemAdd);this.listenTo(header,"view:playlist",this.timeline);this.regionManager.get("header").show(header)}});Application.View.PublicTimelineHeader=Application.View.TimelineHeader.extend({template:{type:"handlebars",template:JST["timeline-public-header"]},className:"timeline-header-public",events:{"click .now":"refresh","change .type":"change","submit .form":"submit"},modelEvents:{"change:view":"updateType","change:type":"updateUI"},placeholders:{a:"Search for music",e:"Search for events",v:"Search for video",p:"Search profiles"},views:{timeline:"v",followings:"p",followers:"p"},ui:{nav:".timeline-nav",form:".form",type:".type",types:".type option",search:".search"},initialize:function(){var options=this.model.get("options");if(options.type!==undefined&&options.search!==undefined){this.model.set({type:options.type,search:options.search,placeholder:this.placeholders[options.type]})}else{this.model.set({type:"v",search:"",placeholder:this.placeholders["v"]})}},refresh:function(){this.trigger("refresh");return false},updateUI:function(event){var view=this.model.get("view"),type=this.model.get("type");var $nav=this.ui.nav.find("."+view);$nav.siblings().removeClass("active");$nav.addClass("active");var $option=this.ui.types.filter("[value="+type+"]");$option.siblings().removeAttr("selected");$option.attr("selected","selected");this.ui.search.attr("placeholder",this.placeholders[type])},updateType:function(){this.model.set("type",this.views[this.model.get("view")])},change:function(event){if(this.model.get("view")==="search"){this.submit(event)}},submit:function(event){var $form=$(event.target).closest("form");var url="search/";url+=encodeURIComponent($form.find("[name=t]").val());url+="/";url+=encodeURIComponent($form.find("[name=s]").val());Backbone.history.navigate(url,true);return false}});Application.View.TimelinePublic=Application.View.Timeline.extend({name:"timeline-public",className:"layout-column public",initialize:function(options){this.initialEvents();this.on("view:followings",function(pid){this.followings(pid)});this.on("view:followers",function(pid){this.followers(pid)});this.on("view:search",function(options){this.search(options)})},timeline:function(options){var status,pid;if(options.pid===undefined){pid=this.model.get("pid");status="p"}else{pid=options.pid;status="m"}var collection=new Application.Collection.Items(undefined,{status:status,pid:pid});var model=new Backbone.Model({loading:true,pid:pid,status:status});var view=new Application.View.Items({collection:collection,model:model});this.bindEvents(view);this.listenTo(view,"item:promoted",function(event){this.trigger("item:promoted",event)});this.regionManager.get("collection").show(view)},followings:function(options){var pid;if(options.pid===undefined){pid=this.model.get("pid")}else{pid=options.pid}var collection=new Application.Collection.Followings;var model=new Backbone.Model({loading:true,pid:pid,count:20,start:10});var view=new Application.View.Followings({collection:collection,model:model});this.bindEvents(view);this.regionManager.get("collection").show(view)},followers:function(options){var pid;if(options.pid===undefined){pid=this.model.get("pid")}else{pid=options.pid}var collection=new Application.Collection.Followers;var model=new Backbone.Model({loading:true,pid:options.pid,count:20,start:10});var view=new Application.View.Followers({collection:collection,model:model});this.bindEvents(view);this.regionManager.get("collection").show(view)},search:function(options){var collection=new Application.Collection.Searches;var search=options.search,type=options.type;var model=new Backbone.Model({loading:true,s:search,t:type});var view=new Application.View.Searches({collection:collection,model:model});this.bindEvents(view);this.listenTo(view,"item:added",function(event){this.trigger("item:added",event)});this.regionManager.get("collection").show(view)},onRender:function(){this.constructor.__super__.onRender.call(this,arguments);var header=new Application.View.PublicTimelineHeader({model:this.model});this.listenTo(header,"refresh",this.refresh);this.regionManager.get("header").show(header)}});Application.View.Timelines=Backbone.Marionette.ItemView.extend({name:"timelines",template:{type:"handlebars",template:JST["timelines"]},className:"layout-container-wide timelines",initialize:function(options){this.initViews();this.initEvents()},initViews:function(){this.subviews=new Backbone.ChildViewContainer;var publicTimeline=new Application.View.TimelinePublic({model:new Backbone.Model({pid:this.options.public.pid,view:this.options.public.view,options:this.options.public.options||{},status:"p"})});this.subviews.add(publicTimeline,"publicTimeline");var privateTimeline=new Application.View.TimelinePrivate({model:new Backbone.Model({pid:this.options.private.pid,view:this.options.private.view,options:this.options.private.options||{},status:"m"})});this.subviews.add(privateTimeline,"privateTimeline")},initEvents:function(){var publicTimeline=this.subviews.findByCustom("publicTimeline"),privateTimeline=this.subviews.findByCustom("privateTimeline");this.listenTo(publicTimeline,"item:promoted",function(items){privateTimeline.trigger("item:add",items[0])});this.listenTo(publicTimeline,"item:added",function(item){privateTimeline.trigger("item:add",item)});this.listenTo(privateTimeline,"item:created",function(event){privateTimeline.trigger("item:add",event)});this.on("public:followings",function(options){publicTimeline.trigger("view:followings",options)});this.on("public:followers",function(options){publicTimeline.trigger("view:followers",options)});this.on("public:timeline",function(options){publicTimeline.trigger("view:timeline",options)});this.on("public:search",function(options){publicTimeline.trigger("view:search",options)});this.on("private:itemAdd",function(options){privateTimeline.trigger("view:itemAdd",options)});this.on("private:timeline",function(options){privateTimeline.trigger("view:timeline",options)})},onRender:function(){var publicTimeline=this.subviews.findByCustom("publicTimeline"),privateTimeline=this.subviews.findByCustom("privateTimeline");this.$el.find(".timeline-public").replaceWith(publicTimeline.render().el);this.$el.find(".timeline-private").replaceWith(privateTimeline.render().el)}});Application.View.UserEmail=Application.View.User.extend({template:{type:"handlebars",template:JST["user-email"]},submit:function(){var data=$(event.target).serializeObject();var self=this,promise=this.model.set(data).save();promise.done(function(){$.cookie("ptnewuser",null);Backbone.history.navigate("timeline",true)});promise.fail(function(){});return false}});Application.Router.Admin=Backbone.Router.extend({_currentView:null,routes:{login:"login",logout:"logout","profile/new":"profileNew","profile/:pid/edit":"profileEdit","profile/:pid":"profileView","profile/:pid/followings":"followings","profile/:pid/followers":"followers","profile/:pid/feeds":"feeds","addfeed/:pid":"addfeed","*default":"home"},initialize:function(){var header=new Application.View.Header({model:new Backbone.Model({pid:Application.session.get("pid")})});Application.header.show(header)},login:function(){var login=new Application.View.Login({model:new Application.Model.Credentials});Application.content.show(login)},logout:function(){Application.session.destroy();Backbone.history.navigate("login",true)},home:function(){var self=this;var check=Application.session.check();check.done(function(){var home=new Application.Admin.View.Home({model:new Backbone.Model({pid:Application.session.get("pid"),message:undefined})});Application.content.show(home)});check.fail(function(){Backbone.history.navigate("login",true)})},profileView:function(pid){var self=this;var check=Application.session.check();check.done(function(){var view=new Application.Admin.View.ProfileView({model:new Application.Model.Profile({pid:pid})});Application.content.show(view)});check.fail(function(){self.invalidSession()})},followings:function(pid){var self=this;Application.session.check(function(){var list=new Application.Admin.View.Followings({pid:pid});list.fetch({success:function(){self.changePage(new FollowingListView({collection:list}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},followers:function(pid){var self=this;Application.session.check(function(){var list=new Application.Admin.View.Followers({pid:pid});list.fetch({success:function(){self.changePage(new FollowersListView({collection:list}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},feeds:function(pid){var self=this;Application.session.check(function(){var list=new Application.Collection.Feeds({pid:pid});list.fetch({success:function(){self.changePage(new FeedsListView({collection:list}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},profileEdit:function(pid){var self=this;Application.session.check(function(){var profile=new Profile({pid:pid});profile.fetch({success:function(){if(profile.get("parentpid")){self.changePage(new EditFeedView({model:profile}))}else{self.changePage(new EditProfileView({model:profile}))}},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},profileNew:function(){var self=this;var check=Application.session.check();check.done(function(){Application.content.show(new Application.Admin.View.ProfileNew)});check.fail(function(){Backbone.history.navigate("login",true)})},addfeed:function(pid){var self=this;Application.session.check(function(){var profile=new Profile({pid:pid});profile.fetch({success:function(){self.changePage(new AddFeedView({model:profile}))},error:function(){self.changePage(new MainView({msg:"Problem retrieving profile '"+pid+"'"}))}})},function(){self.invalidSession()})},invalidSession:function(){self.changePage(new StaticView({name:"Application.session"}))}});Application.Router.User=Backbone.Router.extend({routes:{login:"login",logout:"logout",register:"register",timeline:"timeline",followings:"followings",followers:"followers",suggestions:"suggestions",user:"user","user/email":"userEmail","user/:id":"timeline","followers/:id":"followers","followings/:id":"followings","search/:type/:search":"search"},initialize:function(){this.header=new Application.View.Header({model:Application.session});Application.header.show(this.header)},timeline:function(pid){var self=this;var check=Application.session.check();check.done(function(){if(pid===Application.session.get("pid")){pid=undefined}if(Application.content.is("timelines")===true){Application.content.currentView.trigger("public:timeline",{pid:pid})}else{var timeline=new Application.View.Timelines({"public":{pid:Application.session.get("pid"),view:"timeline",options:{pid:pid}},"private":{pid:Application.session.get("pid"),view:"timeline"}});Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},search:function(type,search){var self=this;var check=Application.session.check();check.done(function(){if(Application.content.is("timelines")===true){Application.content.currentView.trigger("public:search",{type:type,search:search})}else{var timeline=new Application.View.Timelines({"public":{pid:Application.session.get("pid"),view:"search",options:{type:type,search:search}},"private":{pid:Application.session.get("pid"),view:"timeline"}});Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},followers:function(pid){var self=this;var check=Application.session.check();check.done(function(){if(pid===undefined){pid=Application.session.get("pid")}if(Application.content.is("timelines")){Application.content.currentView.trigger("public:followers",{pid:pid})}else{var timeline=new Application.View.Timelines({"public":{pid:pid,view:"followers",options:{pid:pid}},"private":{pid:Application.session.get("pid"),view:"timeline"}});Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},followings:function(pid){var self=this;var check=Application.session.check();check.done(function(){if(pid===undefined){pid=Application.session.get("pid")}if(Application.content.is("timelines")){Application.content.currentView.trigger("public:followings",{pid:pid})}else{var timeline=new Application.View.Timelines({"public":{pid:pid,view:"followings",options:{pid:pid}},"private":{pid:Application.session.get("pid"),view:"timeline"}});Application.content.show(timeline)}});check.fail(function(){Backbone.history.navigate("login",true)})},user:function(){var self=this;var check=Application.session.check();check.done(function(){var profile=new Application.View.User({model:new Application.Model.Profile({pid:Application.session.get("pid")})});Application.content.show(profile)});check.fail(function(){Backbone.history.navigate("login",true)})},userEmail:function(){var self=this;var check=Application.session.check();check.done(function(){var profile=new Application.View.UserEmail({model:new Application.Model.Profile({pid:Application.session.get("pid")})});
Application.content.show(profile)});check.fail(function(){Backbone.history.navigate("login",true)})},suggestions:function(){var self=this;var check=Application.session.check();check.done(function(){var suggestions=new Application.View.Suggestions({collection:new Application.Collection.Suggestions,model:new Backbone.Model({loading:false,location:undefined})});Application.content.show(suggestions)});check.fail(function(){Backbone.history.navigate("login",true)})},login:function(){var login=new Application.View.Login({model:new Application.Model.Credentials});Application.content.show(login)},register:function(){var register=new Application.View.Register({model:new Application.Model.Register});Application.content.show(register)},logout:function(){Application.session.destroy();Backbone.history.navigate("login",true)}});
/*
//@ sourceMappingURL=/-assets/javascripts/application.map
*/